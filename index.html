<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Account Monitor</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #06080d;
  --bg-card: #0c1019;
  --bg-card-border: #161d2c;
  --bg-row-alt: #0a0e16;
  --bg-row-hover: #111827;
  --text: #e2e8f0;
  --text-dim: #64748b;
  --text-label: #8892a4;
  --accent: #3b82f6;
  --green: #22c55e;
  --red: #ef4444;
  --yellow: #eab308;
  --font: 'DM Sans', -apple-system, sans-serif;
  --mono: 'JetBrains Mono', monospace;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* --- Header --- */
.header {
  padding: 24px 32px 20px;
  border-bottom: 1px solid var(--bg-card-border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.header-left { display: flex; align-items: center; gap: 14px; }
.header-logo {
  width: 10px; height: 10px;
  border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
  animation: pulse-dot 2.5s ease-in-out infinite;
}
.header-logo.offline { background: var(--red); box-shadow: 0 0 8px rgba(239, 68, 68, 0.5); }
.header-logo.stale { background: var(--yellow); box-shadow: 0 0 8px rgba(234, 179, 8, 0.5); }

@keyframes pulse-dot {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.header-title {
  font-size: 15px;
  font-weight: 600;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  color: var(--text-dim);
}
.header-right {
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-dim);
}

/* --- Info Tooltip --- */
.info-wrap { position: relative; }
.info-icon {
  width: 18px; height: 18px;
  border-radius: 50%;
  border: 1px solid var(--text-dim);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-style: italic;
  font-family: Georgia, serif;
  color: var(--text-dim);
  cursor: pointer;
  transition: border-color 0.2s, color 0.2s;
  user-select: none;
  flex-shrink: 0;
}
.info-icon:hover { border-color: var(--text); color: var(--text); }

.info-popup {
  display: none;
  position: absolute;
  top: calc(100% + 10px);
  right: 0;
  width: 280px;
  background: #1a2235;
  border: 1px solid #2a3549;
  border-radius: 10px;
  padding: 16px 18px;
  z-index: 100;
  box-shadow: 0 12px 32px rgba(0,0,0,0.5);
}
.info-popup.show { display: block; }
.info-popup-title {
  font-family: var(--font);
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 8px;
}
.info-popup-text {
  font-family: var(--font);
  font-size: 12px;
  color: var(--text-dim);
  line-height: 1.6;
}

/* --- Main --- */
.main { padding: 28px 32px; max-width: 1400px; margin: 0 auto; }

/* --- Account Cards Grid --- */
.accounts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(560px, 1fr));
  gap: 20px;
}

/* --- Account Card --- */
.account-card {
  background: var(--bg-card);
  border: 1px solid var(--bg-card-border);
  border-radius: 12px;
  overflow: hidden;
  transition: border-color 0.2s ease;
}
.account-card:hover { border-color: #1e293b; }

.card-header {
  padding: 18px 22px 14px;
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  border-bottom: 1px solid var(--bg-card-border);
  cursor: pointer;
  user-select: none;
  transition: background 0.15s ease;
}
.card-header:hover { background: var(--bg-card-hover, #111827); }

.card-header-left { display: flex; align-items: flex-start; gap: 10px; }
.card-chevron {
  margin-top: 3px;
  width: 16px; height: 16px;
  flex-shrink: 0;
  transition: transform 0.25s ease;
  color: var(--text-dim);
}
.card-chevron.collapsed { transform: rotate(-90deg); }

.card-body {
  overflow: hidden;
  transition: grid-template-rows 0.3s ease;
  display: grid;
  grid-template-rows: 1fr;
}
.card-body.collapsed {
  grid-template-rows: 0fr;
}
.card-body-inner {
  overflow: hidden;
}
.card-name {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 3px;
}
.card-meta {
  font-size: 12px;
  color: var(--text-dim);
  font-family: var(--mono);
}
.card-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  font-family: var(--mono);
  font-weight: 500;
  padding: 4px 10px;
  border-radius: 20px;
  background: rgba(34, 197, 94, 0.08);
  color: var(--green);
}
.card-status.stale {
  background: rgba(234, 179, 8, 0.08);
  color: var(--yellow);
}
.card-status.offline {
  background: rgba(239, 68, 68, 0.08);
  color: var(--red);
}
.card-status-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: currentColor;
}

/* --- Metrics Row --- */
.metrics {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0;
}
.metric {
  padding: 16px 22px;
  border-right: 1px solid var(--bg-card-border);
  border-bottom: 1px solid var(--bg-card-border);
}
.metric:nth-child(4n) { border-right: none; }

.metric-label {
  font-size: 11px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  color: var(--text-label);
  margin-bottom: 6px;
}
.metric-value {
  font-family: var(--mono);
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
  line-height: 1;
}
.metric-value.positive { color: var(--green); }
.metric-value.negative { color: var(--red); }
.metric-value .currency {
  font-size: 12px;
  font-weight: 400;
  color: var(--text-dim);
  margin-right: 2px;
}
.metric-value .pct {
  font-size: 13px;
  font-weight: 400;
  margin-left: 1px;
}

/* --- Positions Table --- */
.positions-section { padding: 0; }
.positions-header {
  padding: 12px 22px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  color: var(--text-dim);
  border-bottom: 1px solid var(--bg-card-border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  user-select: none;
  transition: background 0.15s ease;
}
.positions-header:hover { background: var(--bg-row-hover); }
.positions-header.no-border { border-bottom: none; }

.pos-chevron {
  width: 12px; height: 12px;
  flex-shrink: 0;
  transition: transform 0.25s ease;
  color: var(--text-dim);
}
.pos-chevron.collapsed { transform: rotate(-90deg); }

.positions-body {
  overflow: hidden;
  display: grid;
  grid-template-rows: 1fr;
  transition: grid-template-rows 0.3s ease;
}
.positions-body.collapsed {
  grid-template-rows: 0fr;
}
.positions-body-inner {
  overflow: hidden;
}

.positions-table { width: 100%; border-collapse: collapse; }
.positions-table th {
  padding: 8px 12px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-dim);
  text-align: right;
  border-bottom: 1px solid var(--bg-card-border);
}
.positions-table th:first-child { text-align: left; padding-left: 22px; }
.positions-table th:last-child { padding-right: 22px; }

.positions-table td {
  padding: 10px 12px;
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 400;
  color: var(--text);
  text-align: right;
  border-bottom: 1px solid var(--bg-card-border);
}
.positions-table td:first-child { text-align: left; padding-left: 22px; }
.positions-table td:last-child { padding-right: 22px; }

.positions-table tr:last-child td { border-bottom: none; }
.positions-table tr:nth-child(even) { background: var(--bg-row-alt); }
.positions-table tr:hover td { background: var(--bg-row-hover); }

.dir-buy { color: var(--green); font-weight: 600; }
.dir-sell { color: var(--red); font-weight: 600; }
.pnl-pos { color: var(--green); }
.pnl-neg { color: var(--red); }

.no-positions {
  padding: 20px 22px;
  text-align: center;
  color: var(--text-dim);
  font-size: 13px;
}

/* --- History Button (on card header) --- */
.history-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 28px; height: 28px;
  border-radius: 6px;
  border: 1px solid var(--bg-card-border);
  background: transparent;
  color: var(--text-dim);
  cursor: pointer;
  transition: all 0.15s ease;
  flex-shrink: 0;
}
.history-btn:hover {
  background: var(--bg-row-hover);
  border-color: var(--text-dim);
  color: var(--text);
}
.history-btn svg { width: 14px; height: 14px; }

.card-header-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* --- History Flyout --- */
.flyout-overlay {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 1000;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px);
  animation: fadeIn 0.15s ease;
}
.flyout-overlay.show { display: flex; justify-content: center; align-items: flex-start; }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.flyout-panel {
  width: 94%;
  max-width: 700px;
  max-height: 85vh;
  margin-top: 5vh;
  background: var(--bg-card);
  border: 1px solid var(--bg-card-border);
  border-radius: 14px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  animation: slideUp 0.2s ease;
}

.flyout-header {
  padding: 20px 24px 16px;
  border-bottom: 1px solid var(--bg-card-border);
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  flex-shrink: 0;
}
.flyout-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
}
.flyout-subtitle {
  font-size: 12px;
  color: var(--text-dim);
  font-family: var(--mono);
}
.flyout-close {
  width: 32px; height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  border: none;
  background: transparent;
  color: var(--text-dim);
  font-size: 20px;
  cursor: pointer;
  transition: all 0.15s ease;
  flex-shrink: 0;
}
.flyout-close:hover {
  background: var(--bg-row-hover);
  color: var(--text);
}

.flyout-body {
  overflow-y: auto;
  flex: 1;
  -webkit-overflow-scrolling: touch;
}

.flyout-summary {
  padding: 14px 24px;
  display: flex;
  gap: 24px;
  border-bottom: 1px solid var(--bg-card-border);
  flex-shrink: 0;
}
.flyout-stat-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-dim);
  margin-bottom: 4px;
}
.flyout-stat-value {
  font-family: var(--mono);
  font-size: 14px;
  font-weight: 600;
}

.flyout-table { width: 100%; border-collapse: collapse; }
.flyout-table th {
  padding: 10px 12px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-dim);
  text-align: right;
  border-bottom: 1px solid var(--bg-card-border);
  position: sticky;
  top: 0;
  background: var(--bg-card);
  z-index: 1;
}
.flyout-table th:first-child { text-align: left; padding-left: 24px; }
.flyout-table th:last-child { padding-right: 24px; }
.flyout-table td {
  padding: 10px 12px;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text);
  text-align: right;
  border-bottom: 1px solid var(--bg-card-border);
}
.flyout-table td:first-child { text-align: left; padding-left: 24px; }
.flyout-table td:last-child { padding-right: 24px; }
.flyout-table tr:nth-child(even) { background: var(--bg-row-alt); }
.flyout-table tr:hover td { background: var(--bg-row-hover); }
.flyout-table tr:last-child td { border-bottom: none; }

.flyout-empty {
  padding: 40px 24px;
  text-align: center;
  color: var(--text-dim);
  font-size: 13px;
}

/* --- State Screens --- */
.state-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 60vh;
  text-align: center;
  gap: 16px;
}
.state-icon { font-size: 36px; margin-bottom: 4px; }
.state-title { font-size: 18px; font-weight: 600; color: var(--text); }
.state-desc { font-size: 14px; color: var(--text-dim); max-width: 400px; line-height: 1.6; }

.spinner {
  width: 28px; height: 28px;
  border: 3px solid var(--bg-card-border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* --- Responsive --- */
@media (max-width: 640px) {
  .header {
    padding: 14px 16px;
    flex-wrap: wrap;
    gap: 8px;
  }
  .header-title { font-size: 13px; }
  .header-right { font-size: 11px; }
  .main { padding: 14px 12px; }
  .accounts-grid { grid-template-columns: 1fr; gap: 14px; }
  .card-header {
    flex-direction: column;
    gap: 8px;
    padding: 14px 16px 12px;
  }
  .card-name { font-size: 15px; }
  .card-status { align-self: flex-start; }
  .card-header-right { align-self: flex-start; }
  .metrics { grid-template-columns: repeat(2, 1fr); }
  .metric {
    padding: 12px 16px;
  }
  .metric:nth-child(2n) { border-right: none; }
  .metric-value { font-size: 15px; }
  .metric-value .currency { font-size: 11px; }
  .positions-header { padding: 10px 16px; }
  .positions-table th, .positions-table td { padding: 8px 6px; font-size: 11px; }
  .positions-table th:first-child, .positions-table td:first-child { padding-left: 16px; }
  .positions-table th:last-child, .positions-table td:last-child { padding-right: 16px; }
  .info-popup { width: 250px; }
  .flyout-panel { width: 100%; max-height: 90vh; margin-top: 0; border-radius: 0 0 14px 14px; }
  .flyout-header { padding: 16px 16px 14px; }
  .flyout-summary { padding: 12px 16px; gap: 16px; }
  .flyout-table th { padding: 8px 8px; }
  .flyout-table td { padding: 9px 8px; font-size: 11px; }
  .flyout-table th:first-child, .flyout-table td:first-child { padding-left: 16px; }
  .flyout-table th:last-child, .flyout-table td:last-child { padding-right: 16px; }
}
</style>
</head>

<body>

<div class="header">
  <div class="header-left">
    <div class="header-logo" id="globalStatus"></div>
    <div class="header-title">Account Monitor</div>
  </div>
  <div class="header-right">
    <span id="lastUpdate">Connecting...</span>
    <div class="info-wrap">
      <div class="info-icon" id="infoToggle">i</div>
      <div class="info-popup" id="infoPopup">
        <div class="info-popup-title">How updates work</div>
        <div class="info-popup-text">
          This page receives a live feed from the account monitoring system. Updates are automatic â€” no need to refresh.
        </div>
        <div class="info-popup-text" style="margin-top:8px">
          <strong>Update frequency:</strong><br>
          When positions are open: every 5 seconds<br>
          When no positions: once per minute
        </div>
      </div>
    </div>
  </div>
</div>

<div class="main" id="app">
  <div class="state-screen" id="loadingState">
    <div class="spinner"></div>
    <div class="state-title">Connecting</div>
    <div class="state-desc">Loading account data...</div>
  </div>
</div>

<div class="flyout-overlay" id="historyFlyout">
  <div class="flyout-panel">
    <div class="flyout-header">
      <div>
        <div class="flyout-title" id="flyoutTitle">Trade History</div>
        <div class="flyout-subtitle" id="flyoutSubtitle"></div>
      </div>
      <button class="flyout-close" onclick="closeFlyout()">&times;</button>
    </div>
    <div class="flyout-summary" id="flyoutSummary"></div>
    <div class="flyout-body" id="flyoutBody"></div>
  </div>
</div>

<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FIREBASE_CONFIG = {
  databaseURL: "https://account-monitoring-54ed7-default-rtdb.europe-west1.firebasedatabase.app"
};

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();

const params = new URLSearchParams(window.location.search);
const viewerKey = params.get('v');

const app = document.getElementById('app');
const globalStatus = document.getElementById('globalStatus');
const lastUpdateEl = document.getElementById('lastUpdate');
const infoToggle = document.getElementById('infoToggle');
const infoPopup = document.getElementById('infoPopup');

// Info popup toggle
infoToggle.addEventListener('click', (e) => {
  e.stopPropagation();
  infoPopup.classList.toggle('show');
});
document.addEventListener('click', () => {
  infoPopup.classList.remove('show');
});

// â”€â”€â”€ DATA STORES (script-level scope) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let accountsData = {};
let historyData = {};

// â”€â”€â”€ NO VIEWER KEY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (!viewerKey) {
  document.title = 'Account Monitor';
  app.innerHTML = `
    <div class="state-screen">
      <div class="state-icon">ðŸ”‘</div>
      <div class="state-title">No viewer key provided</div>
      <div class="state-desc">Add your viewer key to the URL:<br>
        <span style="font-family:var(--mono);color:var(--accent);font-size:13px">
          ${window.location.origin}${window.location.pathname}?v=yourkey
        </span>
      </div>
    </div>`;
} else {
  document.title = viewerKey.charAt(0).toUpperCase() + viewerKey.slice(1) + ' â€” Account Monitor';

  // â”€â”€â”€ LISTEN FOR DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const viewerRef = db.ref('viewers/' + viewerKey);
  let lastDataTime = null;

  viewerRef.on('value', (snapshot) => {
    const data = snapshot.val();

    if (!data) {
      app.innerHTML = `
        <div class="state-screen">
          <div class="state-icon">ðŸ“­</div>
          <div class="state-title">No accounts found</div>
          <div class="state-desc">No data found for viewer key "<strong>${viewerKey}</strong>". Make sure the account monitor is running.</div>
        </div>`;
      globalStatus.className = 'header-logo offline';
      lastUpdateEl.textContent = 'No data';
      return;
    }

    // Separate live accounts from history and snapshots
    const accounts = {};
    historyData = {};
    for (const [key, val] of Object.entries(data)) {
      if (key.endsWith('_history')) {
        // Strip "_history" suffix to get login number
        const login = key.replace('_history', '');
        historyData[login] = val;
      } else if (key.endsWith('_snapshots')) {
        // Store for future use, ignore for now
      } else {
        accounts[key] = val;
      }
    }

    accountsData = accounts;
    lastDataTime = Date.now();
    renderAccounts(accounts);
    updateGlobalStatus(accounts);
  });

  // â”€â”€â”€ CONNECTIVITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  db.ref('.info/connected').on('value', (snap) => {
    if (snap.val() === false) {
      globalStatus.className = 'header-logo offline';
      lastUpdateEl.textContent = 'Disconnected';
    }
  });

  // â”€â”€â”€ LIVE TICKER - update header + staleness every second â”€â”€â”€
  setInterval(() => {
    if (lastDataTime) {
      const ago = Math.floor((Date.now() - lastDataTime) / 1000);
      if (ago < 60) {
        lastUpdateEl.textContent = 'Updated ' + ago + 's ago';
      } else if (ago < 3600) {
        lastUpdateEl.textContent = 'Updated ' + Math.floor(ago / 60) + 'm ago';
      } else {
        lastUpdateEl.textContent = 'Updated ' + Math.floor(ago / 3600) + 'h ago';
      }
    }
    if (Object.keys(accountsData).length > 0) {
      updateGlobalStatus(accountsData);
    }
  }, 1000);
}

// â”€â”€â”€ COLLAPSE STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const collapsedCards = new Set();
const expandedPositions = new Set();

function toggleCard(headerEl) {
  const card = headerEl.closest('.account-card');
  const login = card.dataset.login;
  const body = card.querySelector('.card-body');
  const chevron = card.querySelector('.card-chevron');

  if (collapsedCards.has(login)) {
    collapsedCards.delete(login);
    body.classList.remove('collapsed');
    chevron.classList.remove('collapsed');
    headerEl.style.borderBottom = '';
  } else {
    collapsedCards.add(login);
    body.classList.add('collapsed');
    chevron.classList.add('collapsed');
    headerEl.style.borderBottom = 'none';
  }
}

function togglePositions(headerEl, login) {
  const body = headerEl.nextElementSibling;
  const chevron = headerEl.querySelector('.pos-chevron');

  if (expandedPositions.has(login)) {
    expandedPositions.delete(login);
    body.classList.add('collapsed');
    chevron.classList.add('collapsed');
    headerEl.classList.add('no-border');
  } else {
    expandedPositions.add(login);
    body.classList.remove('collapsed');
    chevron.classList.remove('collapsed');
    headerEl.classList.remove('no-border');
  }
}

// â”€â”€â”€ HISTORY FLYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openHistory(login) {
  const flyout = document.getElementById('historyFlyout');
  const title = document.getElementById('flyoutTitle');
  const subtitle = document.getElementById('flyoutSubtitle');
  const summary = document.getElementById('flyoutSummary');
  const body = document.getElementById('flyoutBody');

  // Find account name
  const acct = accountsData[login];
  const name = acct ? acct.name : 'Account #' + login;

  title.textContent = 'Trade History';
  subtitle.textContent = name + ' #' + login;

  const trades = historyData[login];

  if (!trades || trades.length === 0) {
    summary.innerHTML = '';
    body.innerHTML = '<div class="flyout-empty">No trade history available yet.<br>History is sent when the v1.3 EA is running.</div>';
    flyout.classList.add('show');
    return;
  }

  // Show most recent trades first
  const reversed = [...trades].reverse();

  // Summary stats
  const totalPnl = reversed.reduce((s, t) => s + t.pnl, 0);
  const wins = reversed.filter(t => t.pnl > 0).length;
  const losses = reversed.filter(t => t.pnl < 0).length;
  const winRate = reversed.length > 0 ? (wins / reversed.length * 100) : 0;
  const pnlClass = totalPnl >= 0 ? 'pnl-pos' : 'pnl-neg';

  summary.innerHTML = `
    <div>
      <div class="flyout-stat-label">Trades</div>
      <div class="flyout-stat-value">${reversed.length}</div>
    </div>
    <div>
      <div class="flyout-stat-label">Net P&L</div>
      <div class="flyout-stat-value ${pnlClass}">${totalPnl >= 0 ? '+' : ''}$${totalPnl.toFixed(2)}</div>
    </div>
    <div>
      <div class="flyout-stat-label">Win Rate</div>
      <div class="flyout-stat-value">${winRate.toFixed(0)}%</div>
    </div>
    <div>
      <div class="flyout-stat-label">W / L</div>
      <div class="flyout-stat-value"><span class="pnl-pos">${wins}</span> / <span class="pnl-neg">${losses}</span></div>
    </div>
  `;

  // Format close time for display (just time portion if today, else date + time)
  function fmtTime(t) {
    if (!t) return 'â€”';
    // t = "2026.02.17 18:31:42"
    const parts = t.split(' ');
    if (parts.length < 2) return t;
    return parts[0].replace(/\./g, '/') + ' ' + parts[1].substring(0, 5);
  }

  let tableHTML = `
    <table class="flyout-table">
      <thead><tr>
        <th>Closed</th>
        <th>Dir</th>
        <th>Vol</th>
        <th>Open</th>
        <th>Close</th>
        <th>P&L</th>
      </tr></thead>
      <tbody>`;

  reversed.forEach(t => {
    const dirClass = t.dir === 'BUY' ? 'dir-buy' : 'dir-sell';
    const pnlCls = t.pnl >= 0 ? 'pnl-pos' : 'pnl-neg';
    const dig = t.op > 100 ? 2 : 5;
    tableHTML += `
      <tr>
        <td>${fmtTime(t.ct)}</td>
        <td class="${dirClass}">${t.dir}</td>
        <td>${t.vol.toFixed(2)}</td>
        <td>${t.op.toFixed(dig)}</td>
        <td>${t.cp.toFixed(dig)}</td>
        <td class="${pnlCls}">${t.pnl >= 0 ? '+' : ''}$${t.pnl.toFixed(2)}</td>
      </tr>`;
  });

  tableHTML += '</tbody></table>';
  body.innerHTML = tableHTML;

  flyout.classList.add('show');
}

function closeFlyout() {
  document.getElementById('historyFlyout').classList.remove('show');
}

// Close flyout on overlay click (not panel click)
document.getElementById('historyFlyout').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeFlyout();
});

// Close flyout on Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeFlyout();
});

// â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAccounts(data) {
  const accounts = Object.values(data);

  let html = '<div class="accounts-grid">';
  accounts.forEach(acct => {
    html += renderCard(acct);
  });
  html += '</div>';

  app.innerHTML = html;

  // Restore collapse state
  collapsedCards.forEach(login => {
    const card = app.querySelector(`.account-card[data-login="${login}"]`);
    if (card) {
      card.querySelector('.card-body').classList.add('collapsed');
      card.querySelector('.card-chevron').classList.add('collapsed');
      card.querySelector('.card-header').style.borderBottom = 'none';
    }
  });

  // Restore expanded positions state
  expandedPositions.forEach(login => {
    const card = app.querySelector(`.account-card[data-login="${login}"]`);
    if (card) {
      const posHeader = card.querySelector('.positions-header');
      const posBody = card.querySelector('.positions-body');
      const posChevron = card.querySelector('.pos-chevron');
      if (posHeader && posBody && posChevron) {
        posBody.classList.remove('collapsed');
        posChevron.classList.remove('collapsed');
        posHeader.classList.remove('no-border');
      }
    }
  });
}

function renderCard(a) {
  const freshness = getFreshness(a.time);
  const statusClass = freshness === 'live' ? '' : freshness;
  const statusLabel = freshness === 'live' ? 'LIVE' : freshness === 'stale' ? 'STALE' : 'OFFLINE';

  const floatClass = a.pnl >= 0 ? 'positive' : 'negative';
  const floatPct = a.bal !== 0 ? (a.pnl / a.bal * 100) : 0;

  let positionsHTML = '';
  const posCount = a.positions ? a.positions.length : 0;
  const posTableHTML = posCount > 0 ? `
            <table class="positions-table">
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Dir</th>
                  <th>Volume</th>
                  <th>Open</th>
                  <th>Current</th>
                  <th>P&L</th>
                </tr>
              </thead>
              <tbody>
                ${a.positions.map(p => `
                  <tr>
                    <td>${p.sy}</td>
                    <td class="${p.dir === 'BUY' ? 'dir-buy' : 'dir-sell'}">${p.dir}</td>
                    <td>${p.vol.toFixed(2)}</td>
                    <td>${formatPrice(p.op)}</td>
                    <td>${formatPrice(p.cp)}</td>
                    <td class="${p.pnl >= 0 ? 'pnl-pos' : 'pnl-neg'}">${formatMoney(p.pnl)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>` : `<div class="no-positions">No open positions</div>`;

  positionsHTML = `
      <div class="positions-section">
        <div class="positions-header no-border" onclick="togglePositions(this, '${a.login}')">
          <span>Open Positions: ${posCount}</span>
          <svg class="pos-chevron collapsed" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="4,2 12,8 4,14"/></svg>
        </div>
        <div class="positions-body collapsed">
          <div class="positions-body-inner">
            ${posTableHTML}
          </div>
        </div>
      </div>`;

  return `
    <div class="account-card" data-login="${a.login}">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left">
          <svg class="card-chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="4,2 12,8 4,14"/></svg>
          <div>
            <div class="card-name">${a.name} <span class="card-meta" style="font-size:13px;margin-left:4px">#${a.login}</span></div>
            <div class="card-meta">${a.broker} Â· ${a.ccy}</div>
          </div>
        </div>
        <div class="card-header-right">
          <div class="history-btn" onclick="event.stopPropagation(); openHistory('${a.login}')" title="Trade History">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          </div>
          <div class="card-status ${statusClass}">
            <div class="card-status-dot"></div>
            ${statusLabel}
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="card-body-inner">
          <div class="metrics">
            <div class="metric">
              <div class="metric-label">Balance</div>
              <div class="metric-value"><span class="currency">$</span>${formatNum(a.bal)}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Equity</div>
              <div class="metric-value"><span class="currency">$</span>${formatNum(a.eq)}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Floating P&L</div>
              <div class="metric-value ${floatClass}">${formatMoney(a.pnl)}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Float %</div>
              <div class="metric-value ${floatClass}">${floatPct >= 0 ? '+' : ''}${floatPct.toFixed(2)}<span class="pct">%</span></div>
            </div>
          </div>
          ${positionsHTML}
        </div>
      </div>
    </div>`;
}

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatNum(n) {
  return n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatMoney(n) {
  const sign = n >= 0 ? '+' : '';
  return `<span class="currency">$</span>${sign}${formatNum(n)}`;
}

function formatPrice(n) {
  if (n >= 100) return n.toFixed(2);
  if (n >= 1) return n.toFixed(4);
  return n.toFixed(5);
}

function getFreshness(timeStr) {
  if (!timeStr) return 'offline';
  // Parse MT5 time format: "2026.02.17 15:28:47"
  const parts = timeStr.replace(/\./g, '-').replace(' ', 'T') + 'Z';
  const then = new Date(parts).getTime();
  const now = Date.now();
  const diffSec = (now - then) / 1000;

  if (diffSec < 0) return 'live';       // Future = timezone diff, treat as live
  if (diffSec < 120) return 'live';     // Under 2 min = live
  if (diffSec < 600) return 'stale';    // 2-10 min = stale
  return 'offline';                      // Over 10 min = offline
}

function updateGlobalStatus(data) {
  const accounts = Object.values(data);
  const freshStates = accounts.map(a => getFreshness(a.time));

  let globalState = 'live';
  if (freshStates.includes('offline')) globalState = 'offline';
  else if (freshStates.includes('stale')) globalState = 'stale';

  globalStatus.className = 'header-logo' + (globalState !== 'live' ? ' ' + globalState : '');

  const times = accounts.map(a => a.time).filter(Boolean);
  if (times.length > 0) {
    const latest = times.sort().reverse()[0];
    lastUpdateEl.textContent = 'Last update: ' + latest;
  }
}
</script>

</body>
</html>
