<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Gold Bot Dashboard</title>
<link rel="icon" type="image/png" href="favicon-32x32.png?v=1">
<link rel="apple-touch-icon" href="apple-touch-icon.png?v=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #06080d;
  --bg-card: #0c1019;
  --bg-card-border: #161d2c;
  --bg-row-alt: #0a0e16;
  --bg-row-hover: #111827;
  --text: #e2e8f0;
  --text-dim: #64748b;
  --text-label: #8892a4;
  --accent: #3b82f6;
  --green: #22c55e;
  --red: #ef4444;
  --yellow: #eab308;
  --font: 'DM Sans', -apple-system, sans-serif;
  --mono: 'JetBrains Mono', monospace;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* --- Hamburger Button --- */
.hamburger {
  width: 36px; height: 36px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 5px;
  cursor: pointer;
  border-radius: 8px;
  border: none;
  background: transparent;
  padding: 0;
  flex-shrink: 0;
  transition: background 0.15s ease;
}
.hamburger:hover { background: var(--bg-row-hover); }
.hamburger span {
  display: block;
  width: 18px; height: 2px;
  background: var(--text-dim);
  border-radius: 1px;
  transition: background 0.15s ease;
}
.hamburger:hover span { background: var(--text); }

/* --- Nav Menu --- */
.nav-overlay {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 2000;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  animation: fadeIn 0.15s ease;
}
.nav-overlay.show { display: block; }

.nav-panel {
  position: fixed;
  top: 0; left: 0; bottom: 0;
  width: 280px;
  background: var(--bg-card);
  border-right: 1px solid var(--bg-card-border);
  display: flex;
  flex-direction: column;
  z-index: 2001;
  animation: slideRight 0.2s ease;
}
@keyframes slideRight { from { transform: translateX(-100%); } to { transform: translateX(0); } }

.nav-header {
  padding: 20px 20px 16px;
  border-bottom: 1px solid var(--bg-card-border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.nav-title {
  font-size: 14px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-dim);
}
.nav-close {
  width: 32px; height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  border: none;
  background: transparent;
  color: var(--text-dim);
  font-size: 20px;
  cursor: pointer;
  transition: all 0.15s ease;
}
.nav-close:hover { background: var(--bg-row-hover); color: var(--text); }

.nav-body {
  flex: 1;
  padding: 12px 0;
}
.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 20px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-dim);
  text-decoration: none;
  cursor: pointer;
  transition: all 0.15s ease;
}
.nav-item:hover { background: var(--bg-row-hover); color: var(--text); }
.nav-item.active {
  color: var(--text);
  background: rgba(59, 130, 246, 0.08);
  border-right: 2px solid var(--accent);
}
.nav-item svg { width: 18px; height: 18px; flex-shrink: 0; opacity: 0.6; }
.nav-item.active svg { opacity: 1; }

.nav-footer {
  padding: 16px 20px;
  border-top: 1px solid var(--bg-card-border);
}
.nav-footer-label {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  color: var(--text-dim);
  margin-bottom: 10px;
}
.nav-link {
  display: block;
  padding: 8px 0;
  font-size: 13px;
  color: var(--accent);
  text-decoration: none;
  transition: color 0.15s ease;
}
.nav-link:hover { color: #60a5fa; }

/* --- Header --- */
.header {
  padding: 24px 32px 20px;
  border-bottom: 1px solid var(--bg-card-border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.header-left { display: flex; align-items: center; gap: 14px; }
.header-logo {
  width: 10px; height: 10px;
  border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
  animation: pulse-dot 2.5s ease-in-out infinite;
}
.header-logo.offline { background: var(--red); box-shadow: 0 0 8px rgba(239, 68, 68, 0.5); }
.header-logo.stale { background: var(--yellow); box-shadow: 0 0 8px rgba(234, 179, 8, 0.5); }
.header-logo.closed { background: #94a3b8; box-shadow: 0 0 8px rgba(148, 163, 184, 0.5); }

@keyframes pulse-dot {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.header-titles {
  display: flex;
  flex-direction: column;
  gap: 1px;
}
.header-viewer {
  font-size: 15px;
  font-weight: 600;
  letter-spacing: 0.3px;
  color: var(--text);
  line-height: 1.2;
}
.header-subtitle {
  font-size: 10px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-dim);
  line-height: 1.2;
}
.header-right {
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-dim);
}

/* --- Info Tooltip --- */
.info-wrap { position: relative; }
.info-icon {
  width: 18px; height: 18px;
  border-radius: 50%;
  border: 1px solid var(--text-dim);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-style: italic;
  font-family: Georgia, serif;
  color: var(--text-dim);
  cursor: pointer;
  transition: border-color 0.2s, color 0.2s;
  user-select: none;
  flex-shrink: 0;
}
.info-icon:hover { border-color: var(--text); color: var(--text); }

.info-popup {
  display: none;
  position: absolute;
  top: calc(100% + 10px);
  right: 0;
  width: 280px;
  background: #1a2235;
  border: 1px solid #2a3549;
  border-radius: 10px;
  padding: 16px 18px;
  z-index: 100;
  box-shadow: 0 12px 32px rgba(0,0,0,0.5);
}
.info-popup.show { display: block; }
.info-popup-title {
  font-family: var(--font);
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 8px;
}
.info-popup-text {
  font-family: var(--font);
  font-size: 12px;
  color: var(--text-dim);
  line-height: 1.6;
}

/* --- Main --- */
.main { padding: 28px 32px; max-width: 1400px; margin: 0 auto; }

/* --- Accounts Summary Card --- */
.summary-card {
  background: var(--bg-card);
  border: 1px solid var(--bg-card-border);
  border-radius: 12px;
  margin-bottom: 24px;
}
.summary-card-header {
  padding: 14px 22px 0;
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-dim);
  display: flex;
  align-items: center;
  gap: 8px;
  position: relative;
}
.summary-info-icon {
  width: 16px; height: 16px;
  border-radius: 50%;
  border: 1px solid var(--text-dim);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-style: italic;
  font-family: Georgia, serif;
  color: var(--text-dim);
  cursor: pointer;
  transition: border-color 0.2s, color 0.2s;
  user-select: none;
  flex-shrink: 0;
}
.summary-info-icon:hover { border-color: var(--text); color: var(--text); }
.summary-info-popup {
  display: none;
  position: absolute;
  top: calc(100% + 8px);
  left: 22px;
  width: 280px;
  background: #1a2235;
  border: 1px solid #2a3549;
  border-radius: 10px;
  padding: 14px 16px;
  z-index: 100;
  box-shadow: 0 12px 32px rgba(0,0,0,0.5);
}
.summary-info-popup.show { display: block; }
.summary-info-popup p {
  font-family: var(--font);
  font-size: 12px;
  color: var(--text-dim);
  line-height: 1.6;
  margin: 0 0 6px;
}
.summary-info-popup p:last-child { margin-bottom: 0; }
.summary-card-body {
  display: grid;
  grid-template-columns: 1fr 1fr;
  padding: 14px 22px 18px;
  gap: 16px 32px;
}
.summary-item {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.summary-item-label {
  font-size: 11px;
  color: var(--text-dim);
  letter-spacing: 0.3px;
}
.summary-item-value {
  font-size: 22px;
  font-weight: 600;
  color: var(--text);
  font-family: var(--mono);
}
.summary-item-value .currency {
  font-size: 15px;
  color: var(--text-dim);
  margin-right: 2px;
}
.summary-item-value .pct {
  font-size: 14px;
  margin-left: 1px;
}
.summary-pnl-row {
  display: flex;
  align-items: baseline;
  gap: 10px;
}
.summary-pnl-pct {
  font-size: 14px;
  font-family: var(--mono);
}
.summary-item-value.positive, .summary-pnl-pct.positive { color: var(--green); }
.summary-item-value.negative, .summary-pnl-pct.negative { color: var(--red); }

/* --- Account Cards Grid --- */
.accounts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(560px, 1fr));
  gap: 20px;
}
.viewer-section {
  border: 1px solid var(--bg-card-border);
  border-radius: 14px;
  padding: 20px;
  margin-bottom: 24px;
}
.master-card {
  border-color: rgba(59, 130, 246, 0.3);
}
.master-card .card-name {
  color: #60a5fa;
}
.master-bot-group {
  margin-bottom: 12px;
}
.master-bot-group:last-child {
  margin-bottom: 0;
}
.master-bot-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 8px;
  margin-bottom: 4px;
  border-left: 3px solid #60a5fa;
  background: rgba(59, 130, 246, 0.06);
  border-radius: 0 6px 6px 0;
}
.master-bot-name {
  font-weight: 600;
  font-size: 13px;
  color: #60a5fa;
}
.master-bot-stats {
  font-size: 12px;
  color: var(--text-dim);
}
.master-label-cell, .master-comment-cell {
  font-size: 11px;
  color: var(--text-dim);
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.viewer-section .summary-card {
  border: none;
  margin-bottom: 12px;
  padding: 0;
}
.viewer-section .summary-card-header {
  padding-left: 4px;
}
.viewer-section .summary-card-body {
  padding: 10px 4px 4px;
}
.viewer-section .accounts-grid {
  gap: 16px;
}

/* --- Account Card --- */
.account-card {
  background: var(--bg-card);
  border: 1px solid var(--bg-card-border);
  border-radius: 12px;
  overflow: hidden;
  transition: border-color 0.2s ease;
}
.account-card:hover { border-color: #1e293b; }

.card-header {
  padding: 18px 22px 14px;
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  border-bottom: 1px solid var(--bg-card-border);
  cursor: pointer;
  user-select: none;
  transition: background 0.15s ease;
}
.card-header:hover { background: var(--bg-card-hover, #111827); }

.card-header-left { display: flex; align-items: flex-start; gap: 10px; }
.card-chevron {
  margin-top: 3px;
  width: 16px; height: 16px;
  flex-shrink: 0;
  transition: transform 0.25s ease;
  color: var(--text-dim);
}
.card-chevron.collapsed { transform: rotate(-90deg); }

.card-body {
  overflow: hidden;
  transition: grid-template-rows 0.3s ease;
  display: grid;
  grid-template-rows: 1fr;
}
.card-body.collapsed {
  grid-template-rows: 0fr;
}
.card-body-inner {
  overflow: hidden;
}
.card-name {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 3px;
}
.card-meta {
  font-size: 12px;
  color: var(--text-dim);
  font-family: var(--mono);
}
.card-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  font-family: var(--mono);
  font-weight: 500;
  padding: 4px 10px;
  border-radius: 20px;
  background: rgba(34, 197, 94, 0.08);
  color: var(--green);
}
.card-status.stale {
  background: rgba(234, 179, 8, 0.08);
  color: var(--yellow);
}
.card-status.closed {
  background: rgba(148, 163, 184, 0.08);
  color: #94a3b8;
}
.card-status.offline {
  background: rgba(239, 68, 68, 0.08);
  color: var(--red);
}
.card-status-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: currentColor;
}

/* --- Metrics Row --- */
.metrics {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0;
}
.metric {
  padding: 16px 22px;
  border-right: 1px solid var(--bg-card-border);
  border-bottom: 1px solid var(--bg-card-border);
}
.metric:nth-child(4n) { border-right: none; }

.metric-label {
  font-size: 11px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  color: var(--text-label);
  margin-bottom: 6px;
}
.metric-value {
  font-family: var(--mono);
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
  line-height: 1;
}
.metric-value.positive { color: var(--green); }
.metric-value.negative { color: var(--red); }
.metric-value .currency {
  font-size: 12px;
  font-weight: 400;
  color: var(--text-dim);
  margin-right: 2px;
}
.metric-value .pct {
  font-size: 13px;
  font-weight: 400;
  margin-left: 1px;
}

/* --- Positions Table --- */
.positions-section { padding: 0; }
.positions-header {
  padding: 12px 22px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  color: var(--text-dim);
  border-bottom: 1px solid var(--bg-card-border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  user-select: none;
  transition: background 0.15s ease;
}
.positions-header:hover { background: var(--bg-row-hover); }
.positions-header.no-border { border-bottom: none; }

.pos-chevron {
  width: 12px; height: 12px;
  flex-shrink: 0;
  transition: transform 0.25s ease;
  color: var(--text-dim);
}
.pos-chevron.collapsed { transform: rotate(-90deg); }

.positions-body {
  overflow: hidden;
  display: grid;
  grid-template-rows: 1fr;
  transition: grid-template-rows 0.3s ease;
}
.positions-body.collapsed {
  grid-template-rows: 0fr;
}
.positions-body-inner {
  overflow: hidden;
}

.positions-table { width: 100%; border-collapse: collapse; }
.positions-table th {
  padding: 8px 12px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-dim);
  text-align: right;
  border-bottom: 1px solid var(--bg-card-border);
}
.positions-table th:first-child { text-align: left; padding-left: 22px; }
.positions-table th:last-child { padding-right: 22px; }

.positions-table td {
  padding: 10px 12px;
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 400;
  color: var(--text);
  text-align: right;
  border-bottom: 1px solid var(--bg-card-border);
}
.positions-table td:first-child { text-align: left; padding-left: 22px; }
.positions-table td:last-child { padding-right: 22px; }

.positions-table tr:last-child td { border-bottom: none; }
.positions-table tr:nth-child(even) { background: var(--bg-row-alt); }
.positions-table tr:hover td { background: var(--bg-row-hover); }

.dir-buy { color: var(--green); font-weight: 600; }
.dir-sell { color: var(--red); font-weight: 600; }
td.dir-buy { color: var(--green); }
td.dir-sell { color: var(--red); }
.pnl-pos { color: var(--green); }
.pnl-neg { color: var(--red); }
td.pnl-pos { color: var(--green); }
td.pnl-neg { color: var(--red); }

.no-positions {
  padding: 20px 22px;
  text-align: center;
  color: var(--text-dim);
  font-size: 13px;
}

/* --- History Button (on card header) --- */
.history-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 28px; height: 28px;
  border-radius: 6px;
  border: 1px solid var(--bg-card-border);
  background: transparent;
  color: var(--text-dim);
  cursor: pointer;
  transition: all 0.15s ease;
  flex-shrink: 0;
}
.history-btn:hover {
  background: var(--bg-row-hover);
  border-color: var(--text-dim);
  color: var(--text);
}
.history-btn svg { width: 14px; height: 14px; }

.card-header-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* --- History Flyout --- */
.flyout-overlay {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 1000;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px);
  animation: fadeIn 0.15s ease;
}
.flyout-overlay.show { display: flex; justify-content: center; align-items: flex-start; }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.flyout-panel {
  width: 94%;
  max-width: 700px;
  max-height: 85vh;
  margin-top: 5vh;
  background: var(--bg-card);
  border: 1px solid var(--bg-card-border);
  border-radius: 14px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  animation: slideUp 0.2s ease;
}

.flyout-header {
  padding: 20px 24px 16px;
  border-bottom: 1px solid var(--bg-card-border);
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  flex-shrink: 0;
}
.flyout-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
}
.flyout-subtitle {
  font-size: 12px;
  color: var(--text-dim);
  font-family: var(--mono);
}
.flyout-close {
  width: 32px; height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  border: none;
  background: transparent;
  color: var(--text-dim);
  font-size: 20px;
  cursor: pointer;
  transition: all 0.15s ease;
  flex-shrink: 0;
}
.flyout-close:hover {
  background: var(--bg-row-hover);
  color: var(--text);
}

.flyout-body {
  overflow-y: auto;
  flex: 1;
  -webkit-overflow-scrolling: touch;
}

.flyout-summary {
  padding: 14px 24px;
  display: flex;
  gap: 24px;
  border-bottom: 1px solid var(--bg-card-border);
  flex-shrink: 0;
}
.flyout-stat-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-dim);
  margin-bottom: 4px;
}
.flyout-stat-value {
  font-family: var(--mono);
  font-size: 14px;
  font-weight: 600;
}

.flyout-table { width: 100%; border-collapse: collapse; }
.flyout-table th {
  padding: 10px 12px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-dim);
  text-align: right;
  border-bottom: 1px solid var(--bg-card-border);
  position: sticky;
  top: 0;
  background: var(--bg-card);
  z-index: 1;
}
.flyout-table th:first-child { text-align: left; padding-left: 24px; }
.flyout-table th:last-child { padding-right: 24px; }
.flyout-table td {
  padding: 10px 12px;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text);
  text-align: right;
  border-bottom: 1px solid var(--bg-card-border);
}
.flyout-table td:first-child { text-align: left; padding-left: 24px; }
.flyout-table td:last-child { padding-right: 24px; }
.flyout-table tr:nth-child(even) { background: var(--bg-row-alt); }
.flyout-table tr:hover td { background: var(--bg-row-hover); }
.flyout-table tr:last-child td { border-bottom: none; }
.flyout-table td.pnl-pos { color: var(--green); }
.flyout-table td.pnl-neg { color: var(--red); }
.flyout-table td.dir-buy { color: var(--green); }
.flyout-table td.dir-sell { color: var(--red); }

.flyout-empty {
  padding: 40px 24px;
  text-align: center;
  color: var(--text-dim);
  font-size: 13px;
}

/* --- Market Page --- */
.page { display: none; }
.page.active { display: block; }

.market-chart {
  background: var(--bg-card);
  overflow: hidden;
  height: 55vh;
  min-height: 350px;
}
.market-chart iframe { width: 100%; height: 100%; border: none; }

.calendar-card {
  background: var(--bg-card);
  border: 1px solid var(--bg-card-border);
  border-radius: 12px;
  overflow: hidden;
  margin-top: 20px;
}
.calendar-header {
  padding: 16px 22px 12px;
  border-bottom: 1px solid var(--bg-card-border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.calendar-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}
.calendar-updated {
  font-size: 11px;
  color: var(--text-dim);
  font-family: var(--mono);
}

.calendar-table { width: 100%; border-collapse: collapse; }
.calendar-table th {
  padding: 10px 16px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-dim);
  text-align: left;
  border-bottom: 1px solid var(--bg-card-border);
}
.calendar-table th:last-child { text-align: right; }
.calendar-table td {
  padding: 12px 16px;
  font-size: 13px;
  color: var(--text);
  border-bottom: 1px solid var(--bg-card-border);
}
.calendar-table td:last-child { text-align: right; font-family: var(--mono); font-size: 12px; }
.calendar-table tr:nth-child(even) { background: var(--bg-row-alt); }
.calendar-table tr:hover td { background: var(--bg-row-hover); }
.calendar-table tr:last-child td { border-bottom: none; }

.calendar-day-label {
  padding: 10px 16px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--accent);
  background: rgba(59, 130, 246, 0.05);
  border-bottom: 1px solid var(--bg-card-border);
}
.calendar-table tr:hover .calendar-day-label { background: rgba(59, 130, 246, 0.05); }
.cal-day-past {
  opacity: 0.38;
}

.calendar-time {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-dim);
  white-space: nowrap;
}
.calendar-event-title {
  font-weight: 500;
}
.calendar-forecast {
  color: var(--text-dim);
}
.cal-past td {
  opacity: 0.38;
}
.cal-past:hover td {
  opacity: 0.6;
}
.cal-next td:first-child {
  box-shadow: inset 3px 0 0 var(--accent);
}
.cal-next td {
  background: rgba(224, 188, 104, 0.05) !important;
}
.cal-next .calendar-event-title {
  font-weight: 700;
}
.cal-next .calendar-time {
  color: var(--text);
  font-weight: 600;
}
.calendar-empty {
  padding: 24px 16px;
  text-align: center;
  color: var(--text-dim);
  font-size: 13px;
}

.calendar-footer {
  padding: 12px 22px;
  border-top: 1px solid var(--bg-card-border);
  text-align: right;
}
.calendar-footer a {
  font-size: 12px;
  color: var(--accent);
  text-decoration: none;
  transition: color 0.15s ease;
}
.calendar-footer a:hover { color: #60a5fa; }

/* --- Page Footer --- */
.page-footer {
  padding: 80px 0;
}

/* --- News Section --- */
.news-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  cursor: pointer;
  user-select: none;
}
.news-header:hover { background: rgba(255,255,255,0.02); }
.news-header-left {
  display: flex;
  align-items: center;
  gap: 8px;
}
.news-chevron {
  width: 14px; height: 14px;
  transition: transform 0.2s ease;
  color: var(--text-dim);
}
.news-chevron.expanded { transform: rotate(90deg); }
.news-body {
  display: none;
  border-top: 1px solid var(--bg-card-border);
}
.news-body.expanded { display: block; }
.news-item {
  display: block;
  padding: 14px 20px;
  border-bottom: 1px solid var(--bg-card-border);
  text-decoration: none;
  transition: background 0.15s;
}
.news-item:last-child { border-bottom: none; }
.news-item:hover { background: rgba(255,255,255,0.03); }
.news-item-title {
  font-size: 13px;
  font-weight: 500;
  color: var(--text);
  line-height: 1.5;
}
.news-item-meta {
  font-size: 11px;
  color: var(--text-dim);
  margin-top: 4px;
}
.news-empty {
  padding: 20px;
  text-align: center;
  font-size: 13px;
  color: var(--text-dim);
}

/* --- State Screens --- */
.state-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 60vh;
  text-align: center;
  gap: 16px;
}
.state-icon { font-size: 36px; margin-bottom: 4px; }
.state-title { font-size: 18px; font-weight: 600; color: var(--text); }
.state-desc { font-size: 14px; color: var(--text-dim); max-width: 400px; line-height: 1.6; }

.spinner {
  width: 28px; height: 28px;
  border: 3px solid var(--bg-card-border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* --- Analytics Page --- */
.analytics-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 12px;
  padding: 16px 20px;
  border-bottom: 1px solid var(--bg-card-border);
}
.analytics-controls-left {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
}
.analytics-control-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.analytics-control-label {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-dim);
  padding-left: 2px;
}
.analytics-toggle {
  display: flex;
  background: var(--bg-main);
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid var(--bg-card-border);
}
.analytics-toggle button {
  background: none;
  border: none;
  color: var(--text-dim);
  font-family: 'DM Sans', sans-serif;
  font-size: 12px;
  font-weight: 500;
  padding: 6px 14px;
  cursor: pointer;
  transition: all 0.15s;
}
.analytics-toggle button:hover { color: var(--text); }
.analytics-toggle button.active {
  background: var(--accent);
  color: #000;
}
.acct-dropdown-wrap {
  position: relative;
}
.acct-dropdown-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  font-family: 'DM Sans', sans-serif;
  font-size: 12px;
  font-weight: 500;
  padding: 6px 14px;
  border-radius: 8px;
  border: 1px solid var(--bg-card-border);
  background: var(--bg-main);
  color: var(--text-dim);
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
}
.acct-dropdown-btn:hover { border-color: var(--text-dim); color: var(--text); }
.acct-dropdown-btn.open { border-color: var(--accent); color: var(--accent); }
.acct-dropdown {
  display: none;
  position: absolute;
  top: calc(100% + 6px);
  right: 0;
  min-width: 240px;
  background: var(--bg-card);
  border: 1px solid var(--bg-card-border);
  border-radius: 10px;
  box-shadow: 0 12px 32px rgba(0,0,0,0.5);
  z-index: 500;
  padding: 6px 0;
  max-height: 360px;
  overflow-y: auto;
}
.acct-dropdown.open { display: block; }
.acct-dropdown-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 16px;
  cursor: pointer;
  transition: background 0.12s;
  font-size: 13px;
  color: var(--text);
  user-select: none;
}
.acct-dropdown-item:hover { background: rgba(255,255,255,0.03); }
.acct-dropdown-item.separator {
  border-bottom: 1px solid var(--bg-card-border);
  margin-bottom: 2px;
}
.acct-dd-check {
  width: 16px;
  height: 16px;
  border-radius: 4px;
  border: 1.5px solid var(--text-dim);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.15s;
}
.acct-dropdown-item.active .acct-dd-check {
  border-color: var(--accent);
  background: var(--accent);
}
.acct-dd-check svg {
  width: 10px;
  height: 10px;
  stroke: #000;
  opacity: 0;
}
.acct-dropdown-item.active .acct-dd-check svg { opacity: 1; }
.acct-dd-color {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}
.acct-dd-name {
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.chart-wrap {
  padding: 16px 12px 12px;
  position: relative;
  height: 420px;
}
.chart-empty {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-dim);
  font-size: 13px;
}

/* --- Responsive --- */
@media (max-width: 640px) {
  .header {
    padding: 14px 16px;
    flex-wrap: wrap;
    gap: 8px;
  }
  .header-viewer { font-size: 13px; }
  .header-subtitle { font-size: 9px; }
  .header-right { font-size: 11px; }
  .main { padding: 14px 12px; }
  .accounts-grid { grid-template-columns: 1fr; gap: 14px; }
  .summary-card { margin-bottom: 18px; }
  .summary-card-body {
    gap: 14px 16px;
    padding: 12px 16px 16px;
  }
  .summary-item { min-width: 0; }
  .summary-item-value { font-size: clamp(14px, 4.5vw, 20px); }
  .summary-pnl-pct { font-size: clamp(10px, 2.8vw, 13px); }
  .summary-pnl-row { gap: 6px; }
  .summary-item-label { font-size: 10px; }
  .summary-info-popup { left: 12px; width: calc(100vw - 56px); }
  .card-header {
    flex-direction: column;
    gap: 8px;
    padding: 14px 16px 12px;
  }
  .card-name { font-size: 15px; }
  .card-status { align-self: flex-start; }
  .card-header-right { align-self: flex-start; }
  .metrics { grid-template-columns: repeat(2, 1fr); }
  .metric {
    padding: 12px 16px;
  }
  .metric:nth-child(2n) { border-right: none; }
  .metric-value { font-size: 15px; }
  .metric-value .currency { font-size: 11px; }
  .positions-header { padding: 10px 16px; }
  .positions-table th, .positions-table td { padding: 8px 6px; font-size: 11px; }
  .positions-table th:first-child, .positions-table td:first-child { padding-left: 16px; }
  .positions-table th:last-child, .positions-table td:last-child { padding-right: 16px; }
  .info-popup { width: 250px; }
  .flyout-panel { width: 100%; max-height: 90vh; margin-top: 0; border-radius: 0 0 14px 14px; }
  .flyout-header { padding: 16px 16px 14px; }
  .flyout-summary { padding: 12px 16px; gap: 16px; }
  .flyout-table th { padding: 8px 8px; }
  .flyout-table td { padding: 9px 8px; font-size: 11px; }
  .flyout-table th:first-child, .flyout-table td:first-child { padding-left: 16px; }
  .flyout-table th:last-child, .flyout-table td:last-child { padding-right: 16px; }
  .market-chart { height: 45vh; min-height: 280px; }
  .calendar-card { margin-top: 14px; }
  .calendar-header { padding: 14px 16px 10px; flex-direction: column; align-items: flex-start; gap: 4px; }
  .calendar-table th, .calendar-table td { padding: 10px 12px; font-size: 12px; }
  .calendar-table td:last-child { font-size: 11px; }
  .analytics-controls { padding: 12px 16px; gap: 10px; flex-direction: column; align-items: stretch; }
  .analytics-controls-left { flex-direction: column; }
  .analytics-toggle button { font-size: 11px; padding: 5px 10px; }
  .acct-dropdown-wrap { width: 100%; }
  .acct-dropdown-btn { width: 100%; justify-content: space-between; }
  .acct-dropdown { right: auto; left: 0; min-width: 100%; }
  .chart-wrap { height: 300px; padding: 12px 8px 8px; }
}

@media (min-width: 960px) {
  .summary-card-body {
    grid-template-columns: repeat(4, 1fr);
  }
}
</style>
</head>

<body>

<div class="header">
  <div class="header-left">
    <button class="hamburger" onclick="openNav()" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="header-logo" id="globalStatus"></div>
    <div class="header-titles">
      <div class="header-viewer" id="headerViewer">Gold Bot Dashboard</div>
      <div class="header-subtitle" id="headerSubtitle">Gold Bot Dashboard</div>
    </div>
  </div>
  <div class="header-right">
    <span id="lastUpdate">Connecting...</span>
    <div class="info-wrap">
      <div class="info-icon" id="infoToggle">i</div>
      <div class="info-popup" id="infoPopup">
        <div class="info-popup-title">How updates work</div>
        <div class="info-popup-text">
          This page receives a live feed from the account monitoring system. Updates are automatic ‚Äî no need to refresh.
        </div>
        <div class="info-popup-text" style="margin-top:8px">
          <strong>Update frequency:</strong><br>
          When positions are open: every 5 seconds<br>
          When no positions: once per minute
        </div>
      </div>
    </div>
  </div>
</div>

<div class="main page active" id="pageAccounts">
  <div class="state-screen" id="loadingState">
    <div class="spinner"></div>
    <div class="state-title">Connecting</div>
    <div class="state-desc">Loading account data...</div>
  </div>
</div>

<div class="main page" id="pageMarket">
  <div class="calendar-card">
    <div class="calendar-header" style="border-bottom:none; padding-bottom:0;">
      <div class="calendar-title">Gold / US Dollar (XAU/USD)</div>
    </div>
    <div class="market-chart" id="tvChartContainer"></div>
  </div>
  <div class="calendar-card">
    <div class="calendar-header">
      <div class="calendar-title">üìÖ U.S. Economic Events This Week</div>
      <div class="calendar-updated" id="calendarUpdated"></div>
    </div>
    <div id="calendarBody"><div class="calendar-empty">Loading calendar...</div></div>
    <div class="calendar-footer">
      <a href="https://www.forexfactory.com/calendar?month=this" target="_blank" rel="noopener">Full calendar on Forex Factory ‚Üó</a>
    </div>
  </div>
  <div class="calendar-card">
    <div class="news-header" onclick="toggleNews()">
      <div class="news-header-left">
        <svg class="news-chevron" id="newsChevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="4,2 12,8 4,14"/></svg>
        <div class="calendar-title">üóûÔ∏è Market News</div>
      </div>
      <div class="calendar-updated" id="newsUpdated"></div>
    </div>
    <div class="news-body" id="newsBody"></div>
  </div>
</div>

<div class="main page" id="pageAnalytics">
  <div class="calendar-card">
    <div class="calendar-header" style="border-bottom:none; padding-bottom:0;">
      <div class="calendar-title">Account Growth</div>
    </div>
    <div class="analytics-controls">
      <div class="analytics-controls-left">
        <div class="analytics-control-group">
          <div class="analytics-control-label">Interval</div>
          <div class="analytics-toggle" id="periodToggle">
            <button class="active" data-period="daily">Daily</button>
            <button data-period="weekly">Weekly</button>
            <button data-period="monthly">Monthly</button>
          </div>
        </div>
        <div class="analytics-control-group">
          <div class="analytics-control-label">Range</div>
          <div class="analytics-toggle" id="rangeToggle">
            <button data-range="30">1M</button>
            <button data-range="90">3M</button>
            <button data-range="180">6M</button>
            <button data-range="365">1Y</button>
            <button data-range="ytd">YTD</button>
            <button class="active" data-range="all">All</button>
          </div>
        </div>
      </div>
      <div class="analytics-control-group">
        <div class="analytics-control-label">Accounts</div>
        <div class="acct-dropdown-wrap">
        <button class="acct-dropdown-btn" id="acctDropdownBtn" onclick="toggleAcctDropdown()">
          <span id="acctDropdownLabel">Accounts (0/0)</span>
          <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4,6 8,10 12,6"/></svg>
        </button>
        <div class="acct-dropdown" id="acctDropdown"></div>
        </div>
      </div>
    </div>
    <div class="chart-wrap">
      <canvas id="growthChart"></canvas>
    </div>
  </div>
</div>

<div class="page-footer" id="pageFooter"></div>

<div class="nav-overlay" id="navOverlay" onclick="closeNav()"></div>
<div class="nav-panel" id="navPanel" style="display:none">
  <div class="nav-header">
    <div class="nav-title">Menu</div>
    <button class="nav-close" onclick="closeNav()">&times;</button>
  </div>
  <div class="nav-body">
    <div class="nav-item active" data-page="accounts" onclick="navigateTo('accounts')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
      Accounts
    </div>
    <div class="nav-item" data-page="market" onclick="navigateTo('market')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Market
    </div>
    <div class="nav-item" data-page="analytics" onclick="navigateTo('analytics')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><polyline points="7 14 12 9 16 13 21 8"/></svg>
      Analytics
    </div>
  </div>
  <div class="nav-footer">
    <div class="nav-footer-label">Quick Links</div>
    <a class="nav-link" href="https://my.coinexx.com/dashboard" target="_blank" rel="noopener">Coinexx Dashboard ‚Üó</a>
    <a class="nav-link" href="https://www.coinbase.com/cash" target="_blank" rel="noopener">Coinbase ‚Üó</a>
  </div>
</div>

<div class="flyout-overlay" id="historyFlyout">
  <div class="flyout-panel">
    <div class="flyout-header">
      <div>
        <div class="flyout-title" id="flyoutTitle">Trade History</div>
        <div class="flyout-subtitle" id="flyoutSubtitle"></div>
      </div>
      <button class="flyout-close" onclick="closeFlyout()">&times;</button>
    </div>
    <div class="flyout-summary" id="flyoutSummary"></div>
    <div class="flyout-body" id="flyoutBody"></div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FIREBASE_CONFIG = {
  databaseURL: "https://account-monitoring-54ed7-default-rtdb.europe-west1.firebasedatabase.app"
};

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();

const params = new URLSearchParams(window.location.search);
const viewerKey = params.get('v');
const isAdmin = viewerKey === 'test';

const app = document.getElementById('pageAccounts');
const globalStatus = document.getElementById('globalStatus');
const lastUpdateEl = document.getElementById('lastUpdate');
const infoToggle = document.getElementById('infoToggle');
const infoPopup = document.getElementById('infoPopup');

// Info popup toggle
infoToggle.addEventListener('click', (e) => {
  e.stopPropagation();
  infoPopup.classList.toggle('show');
});
document.addEventListener('click', () => {
  infoPopup.classList.remove('show');
  const sp = document.getElementById('summaryInfoPopup');
  if (sp) sp.classList.remove('show');
});

// ‚îÄ‚îÄ‚îÄ DATA STORES (script-level scope) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let accountsData = {};
let historyData = {};
let dailyHistory = {};    // { login: { "2025-08-15": {bal,pnl,cnt,w,l}, ... } }
let dailyHistoryLoadedLogins = new Set();
let masterData = {};      // { login: { bal, eq, floatingPnl, positions, ... } }
let masterHistoryData = {};  // { login: { gmtOff, trades: [...] } }
// Whether this viewer can see master accounts (future: set by EA flag)
let canViewMaster = false;

// ‚îÄ‚îÄ‚îÄ NO VIEWER KEY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if (!viewerKey) {
  document.title = 'Gold Bot Dashboard';
  app.innerHTML = `
    <div class="state-screen">
      <div class="state-icon">üîë</div>
      <div class="state-title">No viewer key provided</div>
      <div class="state-desc">Add your viewer key to the URL:<br>
        <span style="font-family:var(--mono);color:var(--accent);font-size:13px">
          ${window.location.origin}${window.location.pathname}?v=yourkey
        </span>
      </div>
    </div>`;
} else {
  // ‚îÄ‚îÄ‚îÄ TITLE & HEADER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (isAdmin) {
    document.title = 'Admin ‚Äî Gold Bot Dashboard';
    document.getElementById('headerViewer').textContent = 'Admin';
  } else {
    document.title = viewerKey.charAt(0).toUpperCase() + viewerKey.slice(1) + ' ‚Äî Gold Bot Dashboard';
    document.getElementById('headerViewer').textContent = viewerKey.charAt(0).toUpperCase() + viewerKey.slice(1);
  }
  let viewerDisplayName = '';
  let lastDataTime = null;

  // ‚îÄ‚îÄ‚îÄ Shared: process one viewer's raw data into accounts + history ‚îÄ‚îÄ
  function processViewerData(raw, vKey) {
    const out = { accounts: {}, history: {} };
    if (!raw || typeof raw !== 'object') return out;
    // Find viewerName for this viewer
    let vName = vKey ? vKey.charAt(0).toUpperCase() + vKey.slice(1) : '';
    if (vKey) {
      for (const v of Object.values(raw)) {
        if (v && v.viewerName) { vName = v.viewerName; break; }
      }
    }
    for (const [key, val] of Object.entries(raw)) {
      if (key.endsWith('_history')) {
        out.history[key.replace('_history', '')] = val;
      } else if (key.endsWith('_snapshots')) {
        // Legacy, ignore
      } else if (val && typeof val === 'object' && val.bal !== undefined) {
        if (vKey) { val._viewerKey = vKey; val._viewerName = vName; }
        out.accounts[key] = val;
      }
    }
    return out;
  }

  // ‚îÄ‚îÄ‚îÄ Shared: push merged data into global stores and render ‚îÄ‚îÄ
  function applyData(accounts, history) {
    accountsData = accounts;
    historyData = history;
    lastDataTime = Date.now();
    // Check if any account has showMaster flag (from EA parameter)
    if (!canViewMaster) {
      for (const acct of Object.values(accounts)) {
        if (acct.showMaster) {
          canViewMaster = true;
          console.log('[Master] showMaster flag detected on account', acct.login);
          break;
        }
      }
    }
    renderAccounts(accounts);
    updateGlobalStatus(accounts);
    // Load daily history for any new logins we haven't seen yet
    const newLogins = Object.keys(accounts).filter(l => !dailyHistoryLoadedLogins.has(l));
    if (newLogins.length > 0) {
      newLogins.forEach(l => dailyHistoryLoadedLogins.add(l));
      loadDailyHistory(newLogins);
    }
  }

  if (isAdmin) {
    // ‚îÄ‚îÄ‚îÄ ADMIN: listen to each known viewer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const adminViewerKeys = ['cassidy', 'cathy', 'ali'];
    const adminRaw = {};

    function adminMergeAndRender() {
      const allAccounts = {};
      const allHistory = {};
      for (const [vk, raw] of Object.entries(adminRaw)) {
        const p = processViewerData(raw, vk);
        Object.assign(allAccounts, p.accounts);
        Object.assign(allHistory, p.history);
      }
      applyData(allAccounts, allHistory);
    }

    adminViewerKeys.forEach(vk => {
      db.ref('viewers/' + vk).on('value', (s) => {
        const val = s.val();
        if (val) {
          adminRaw[vk] = val;
          adminMergeAndRender();
        }
      });
    });

  } else {
    // ‚îÄ‚îÄ‚îÄ NORMAL: single viewer listener (unchanged logic) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const viewerRef = db.ref('viewers/' + viewerKey);

    viewerRef.on('value', (snapshot) => {
      const data = snapshot.val();

      if (!data) {
        app.innerHTML = `
          <div class="state-screen">
            <div class="state-icon">üì≠</div>
            <div class="state-title">No accounts found</div>
            <div class="state-desc">No data found for viewer key "<strong>${viewerKey}</strong>". Make sure the account monitor is running.</div>
          </div>`;
        globalStatus.className = 'header-logo offline';
        lastUpdateEl.textContent = 'No data';
        return;
      }

      const p = processViewerData(data, null);

      // Pick up viewerName from any account that has it set
      if (!viewerDisplayName) {
        for (const acct of Object.values(p.accounts)) {
          if (acct.viewerName) {
            viewerDisplayName = acct.viewerName;
            document.title = viewerDisplayName + ' ‚Äî Gold Bot Dashboard';
            document.getElementById('headerViewer').textContent = viewerDisplayName;
            break;
          }
        }
      }

      applyData(p.accounts, p.history);
    });
  }

  // ‚îÄ‚îÄ‚îÄ MASTER ACCOUNTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Admin always sees master. Normal viewers see if any of their accounts has showMaster flag.
  if (isAdmin) canViewMaster = true;
  console.log('[Master] canViewMaster:', canViewMaster, '| isAdmin:', isAdmin);
  db.ref('master').on('value', (snap) => {
    const val = snap.val();
    console.log('[Master] listener fired, data:', val);
    masterData = {};
    masterHistoryData = {};
    if (val) {
      for (const [key, v] of Object.entries(val)) {
        if (key.endsWith('_history')) {
          masterHistoryData[key.replace('_history', '')] = v;
        } else if (v && typeof v === 'object' && v.bal !== undefined) {
          masterData[key] = v;
        }
      }
    }
    // Re-render if we have viewer accounts loaded
    if (Object.keys(accountsData).length > 0) {
      renderAccounts(accountsData);
    }
  }, (err) => {
    console.error('[Master] listener error:', err);
  });

  // ‚îÄ‚îÄ‚îÄ CONNECTIVITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  db.ref('.info/connected').on('value', (snap) => {
    if (snap.val() === false) {
      globalStatus.className = 'header-logo offline';
      lastUpdateEl.textContent = 'Disconnected';
    }
  });

  // ‚îÄ‚îÄ‚îÄ LIVE TICKER - update header + staleness every second ‚îÄ‚îÄ‚îÄ
  setInterval(() => {
    if (lastDataTime) {
      const ago = Math.floor((Date.now() - lastDataTime) / 1000);
      if (ago < 60) {
        lastUpdateEl.textContent = 'Updated ' + ago + 's ago';
      } else if (ago < 3600) {
        lastUpdateEl.textContent = 'Updated ' + Math.floor(ago / 60) + 'm ago';
      } else {
        lastUpdateEl.textContent = 'Updated ' + Math.floor(ago / 3600) + 'h ago';
      }
    }
    if (Object.keys(accountsData).length > 0) {
      updateGlobalStatus(accountsData);
    }
  }, 1000);
}

// ‚îÄ‚îÄ‚îÄ NAV MENU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openNav() {
  document.getElementById('navOverlay').classList.add('show');
  document.getElementById('navPanel').style.display = 'flex';
}
function closeNav() {
  document.getElementById('navOverlay').classList.remove('show');
  document.getElementById('navPanel').style.display = 'none';
}
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeNav();
});

// ‚îÄ‚îÄ‚îÄ PAGE ROUTING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tvWidgetLoaded = false;
let analyticsLoaded = false;

function navigateTo(page) {
  // Hide all pages
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  // Show target page
  const target = document.getElementById('page' + page.charAt(0).toUpperCase() + page.slice(1));
  if (target) target.classList.add('active');

  // Update nav active state
  document.querySelectorAll('.nav-item[data-page]').forEach(item => {
    item.classList.toggle('active', item.dataset.page === page);
  });

  // Lazy-load TradingView widget on first visit
  if (page === 'market' && !tvWidgetLoaded) {
    loadTradingViewWidget();
    tvWidgetLoaded = true;
  }

  // Lazy-load Analytics chart on first visit
  if (page === 'analytics' && !analyticsLoaded) {
    analyticsLoaded = true;
    initAnalytics();
  }

  // Update hash
  window.location.hash = page === 'accounts' ? '' : page;

  closeNav();
}

function loadTradingViewWidget() {
  const container = document.getElementById('tvChartContainer');
  container.innerHTML = '';

  const script = document.createElement('script');
  script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
  script.async = true;
  script.textContent = JSON.stringify({
    "symbol": "OANDA:XAUUSD",
    "interval": "5",
    "timezone": Intl.DateTimeFormat().resolvedOptions().timeZone,
    "theme": "dark",
    "style": "3",
    "locale": "en",
    "backgroundColor": "rgba(12, 16, 25, 1)",
    "gridColor": "rgba(22, 29, 44, 1)",
    "toolbar_bg": "#0c1019",
    "hide_side_toolbar": true,
    "hide_legend": true,
    "hide_volume": true,
    "allow_symbol_change": false,
    "save_image": false,
    "details": false,
    "calendar": false,
    "support_host": "https://www.tradingview.com",
    "width": "100%",
    "height": "100%"
  });

  const wrapper = document.createElement('div');
  wrapper.className = 'tradingview-widget-container';
  wrapper.style.height = '100%';
  wrapper.style.width = '100%';
  const inner = document.createElement('div');
  inner.className = 'tradingview-widget-container__widget';
  inner.style.height = 'calc(100% - 32px)';
  inner.style.width = '100%';
  wrapper.appendChild(inner);
  wrapper.appendChild(script);
  container.appendChild(wrapper);
}

// Handle initial hash on page load
(function() {
  const hash = window.location.hash.replace('#', '');
  if (hash && hash !== 'accounts') {
    navigateTo(hash);
  }
})();

// Handle back/forward navigation
window.addEventListener('hashchange', () => {
  const hash = window.location.hash.replace('#', '') || 'accounts';
  navigateTo(hash);
});

// ‚îÄ‚îÄ‚îÄ ECONOMIC CALENDAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
db.ref('market/calendar').on('value', (snapshot) => {
  const data = snapshot.val();
  const body = document.getElementById('calendarBody');
  const updated = document.getElementById('calendarUpdated');

  if (!data || !data.events || data.events.length === 0) {
    body.innerHTML = '<div class="calendar-empty">No high-impact events this week.</div>';
    updated.textContent = '';
    return;
  }

  // Show last updated in local time
  if (data.lastUpdated) {
    const d = new Date(data.lastUpdated);
    updated.textContent = 'Updated ' + d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) + ' ' + d.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
  }

  // Group events by day (in user's local timezone)
  const now = new Date();
  const dayGroups = {};
  let nextUpcomingIndex = -1;
  const allEvents = [];

  data.events.forEach((e, i) => {
    const d = new Date(e.date);
    const dayKey = d.toLocaleDateString(undefined, { weekday: 'long', month: 'short', day: 'numeric' });
    if (!dayGroups[dayKey]) dayGroups[dayKey] = [];
    dayGroups[dayKey].push({ ...e, _globalIndex: i });
    allEvents.push({ date: d, index: i });
  });

  // Find the first event that hasn't happened yet
  for (let i = 0; i < allEvents.length; i++) {
    if (allEvents[i].date > now) {
      nextUpcomingIndex = allEvents[i].index;
      break;
    }
  }

  let html = `<table class="calendar-table">
    <thead><tr>
      <th>Time</th>
      <th>Event</th>
      <th>Forecast / Prev</th>
    </tr></thead>
    <tbody>`;

  for (const [day, events] of Object.entries(dayGroups)) {
    // Check if all events in this day group are past
    const allPast = events.every(e => new Date(e.date) <= now);
    html += `<tr><td colspan="3" class="calendar-day-label${allPast ? ' cal-day-past' : ''}">${day}</td></tr>`;
    events.forEach(e => {
      const d = new Date(e.date);
      const time = d.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
      const forecast = e.forecast || '‚Äî';
      const previous = e.previous || '‚Äî';
      const isPast = d <= now;
      const isNext = e._globalIndex === nextUpcomingIndex;
      const rowClass = isNext ? 'cal-next' : (isPast ? 'cal-past' : '');
      const titlePrefix = isNext ? '<span style="color:var(--accent);margin-right:4px">‚ñ∏</span>' : '';
      html += `
        <tr${rowClass ? ' class="' + rowClass + '"' : ''}>
          <td><span class="calendar-time">${time}</span></td>
          <td>${titlePrefix}<span class="calendar-event-title">${e.title}</span></td>
          <td><span class="calendar-forecast">${forecast}</span> / ${previous}</td>
        </tr>`;
    });
  }

  html += '</tbody></table>';
  body.innerHTML = html;
});

// ‚îÄ‚îÄ‚îÄ NEWS FEED (lazy-loaded on expand) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let newsLoaded = false;
let newsExpanded = false;

function toggleNews() {
  const chevron = document.getElementById('newsChevron');
  const body = document.getElementById('newsBody');
  newsExpanded = !newsExpanded;

  if (newsExpanded) {
    chevron.classList.add('expanded');
    body.classList.add('expanded');
    if (!newsLoaded) {
      newsLoaded = true;
      body.innerHTML = '<div class="news-empty">Loading...</div>';
      loadNews();
    }
  } else {
    chevron.classList.remove('expanded');
    body.classList.remove('expanded');
  }
}

function loadNews() {
  db.ref('market/news').on('value', (snapshot) => {
    const data = snapshot.val();
    const body = document.getElementById('newsBody');
    const updated = document.getElementById('newsUpdated');

    if (!data || !data.articles || data.articles.length === 0) {
      body.innerHTML = '<div class="news-empty">No news articles available.</div>';
      return;
    }

    if (data.lastUpdated) {
      const d = new Date(data.lastUpdated);
      updated.textContent = 'Updated ' + d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) + ' ' + d.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
    }

    let html = '';
    data.articles.forEach(a => {
      const d = new Date(a.date.replace(' ', 'T') + 'Z');
      const timeStr = d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) + ' ¬∑ ' + d.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
      html += `
        <a class="news-item" href="${a.link}" target="_blank" rel="noopener">
          <div class="news-item-title">${a.title}</div>
          <div class="news-item-meta">${timeStr}${a.author ? ' ¬∑ ' + a.author : ''}</div>
        </a>`;
    });

    body.innerHTML = html;
  });
}

// ‚îÄ‚îÄ‚îÄ ANALYTICS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CHART_COLORS = [
  '#e0bc68', // gold
  '#60a5fa', // blue
  '#34d399', // green
  '#f472b6', // pink
  '#a78bfa', // purple
  '#fb923c', // orange
  '#38bdf8', // sky
  '#f87171', // red
  '#4ade80', // lime
  '#e879f9', // fuchsia
];
const COMBINED_COLOR = '#ffffff';

let growthChart = null;
let analyticsAccounts = {};  // { login: { name, daily } }
let activeAccounts = new Set();
let showCombined = false;
let currentPeriod = 'daily';
let currentRange = 'all';

function initAnalytics() {
  analyticsAccounts = {};
  for (const [login, daily] of Object.entries(dailyHistory)) {
    const acct = accountsData[login];
    const name = acct ? acct.name : login;
    analyticsAccounts[login] = { name, daily };
  }

  if (Object.keys(analyticsAccounts).length === 0) {
    document.querySelector('.chart-wrap').innerHTML = '<div class="chart-empty">Waiting for data...</div>';
    const checkInterval = setInterval(() => {
      for (const [login, daily] of Object.entries(dailyHistory)) {
        const acct = accountsData[login];
        analyticsAccounts[login] = { name: acct ? acct.name : login, daily };
      }
      if (Object.keys(analyticsAccounts).length > 0) {
        clearInterval(checkInterval);
        buildAnalyticsUI();
      }
    }, 500);
    return;
  }

  buildAnalyticsUI();
}

function buildAnalyticsUI() {
  const logins = Object.keys(analyticsAccounts);
  activeAccounts = new Set(logins);
  showCombined = false;

  // Build dropdown items
  buildAcctDropdown();
  updateDropdownLabel();

  // Period toggle listeners
  document.querySelectorAll('#periodToggle button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#periodToggle button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentPeriod = btn.dataset.period;
      renderChart();
    });
  });

  // Range toggle listeners
  document.querySelectorAll('#rangeToggle button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#rangeToggle button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentRange = btn.dataset.range;
      renderChart();
    });
  });

  renderChart();
}

function buildAcctDropdown() {
  const dd = document.getElementById('acctDropdown');
  const logins = Object.keys(analyticsAccounts);
  const checkSvg = '<svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2"><polyline points="2,6 5,9 10,3"/></svg>';

  let html = '';

  // All toggle
  html += `<div class="acct-dropdown-item active" data-login="all" onclick="toggleAcctItem(this)">
    <div class="acct-dd-check">${checkSvg}</div>
    <div class="acct-dd-name">All Accounts</div>
  </div>`;

  // Combined toggle
  html += `<div class="acct-dropdown-item separator" data-login="combined" onclick="toggleAcctItem(this)">
    <div class="acct-dd-check">${checkSvg}</div>
    <div class="acct-dd-color" style="background:${COMBINED_COLOR}"></div>
    <div class="acct-dd-name">Combined</div>
  </div>`;

  // Individual accounts
  logins.forEach((login, i) => {
    const name = analyticsAccounts[login].name;
    const color = CHART_COLORS[i % CHART_COLORS.length];
    html += `<div class="acct-dropdown-item active" data-login="${login}" onclick="toggleAcctItem(this)">
      <div class="acct-dd-check">${checkSvg}</div>
      <div class="acct-dd-color" style="background:${color}"></div>
      <div class="acct-dd-name">${name}</div>
    </div>`;
  });

  dd.innerHTML = html;
}

function toggleAcctDropdown() {
  const btn = document.getElementById('acctDropdownBtn');
  const dd = document.getElementById('acctDropdown');
  const isOpen = dd.classList.contains('open');

  if (isOpen) {
    dd.classList.remove('open');
    btn.classList.remove('open');
  } else {
    dd.classList.add('open');
    btn.classList.add('open');
  }
}

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
  const wrap = document.querySelector('.acct-dropdown-wrap');
  if (wrap && !wrap.contains(e.target)) {
    document.getElementById('acctDropdown')?.classList.remove('open');
    document.getElementById('acctDropdownBtn')?.classList.remove('open');
  }
});

function toggleAcctItem(el) {
  const login = el.dataset.login;
  const logins = Object.keys(analyticsAccounts);

  if (login === 'all') {
    const wasActive = el.classList.contains('active');
    if (wasActive) {
      activeAccounts.clear();
      document.querySelectorAll('.acct-dropdown-item[data-login]').forEach(item => {
        if (item.dataset.login !== 'combined') item.classList.remove('active');
      });
    } else {
      activeAccounts = new Set(logins);
      document.querySelectorAll('.acct-dropdown-item[data-login]').forEach(item => {
        if (item.dataset.login !== 'combined') item.classList.add('active');
      });
    }
  } else if (login === 'combined') {
    showCombined = !showCombined;
    el.classList.toggle('active', showCombined);
  } else {
    el.classList.toggle('active');
    if (activeAccounts.has(login)) {
      activeAccounts.delete(login);
    } else {
      activeAccounts.add(login);
    }
    // Sync "All" state
    const allItem = document.querySelector('.acct-dropdown-item[data-login="all"]');
    allItem.classList.toggle('active', activeAccounts.size === logins.length);
  }

  updateDropdownLabel();
  renderChart();
}

function updateDropdownLabel() {
  const total = Object.keys(analyticsAccounts).length;
  const count = activeAccounts.size;
  const label = document.getElementById('acctDropdownLabel');
  let text = `Accounts (${count}/${total})`;
  if (showCombined) text += ' + Combined';
  label.textContent = text;
}

function getDateCutoff() {
  if (currentRange === 'all') return null;

  const now = new Date();
  if (currentRange === 'ytd') {
    return new Date(now.getFullYear(), 0, 1).toISOString().slice(0, 10);
  }

  const days = parseInt(currentRange);
  const cutoff = new Date(now);
  cutoff.setDate(cutoff.getDate() - days);
  return cutoff.toISOString().slice(0, 10);
}

function aggregateData(daily, period) {
  const cutoff = getDateCutoff();
  let dates = Object.keys(daily).sort();

  if (cutoff) {
    dates = dates.filter(d => d >= cutoff);
  }

  if (dates.length === 0) return [];

  if (period === 'daily') {
    return dates.map(d => ({ date: d, bal: daily[d].bal }));
  }

  if (period === 'weekly') {
    const weeks = {};
    dates.forEach(d => {
      const dt = new Date(d + 'T00:00:00');
      const day = dt.getDay();
      const diff = dt.getDate() - day + (day === 0 ? -6 : 1);
      const monday = new Date(dt);
      monday.setDate(diff);
      const weekKey = monday.toISOString().slice(0, 10);
      weeks[weekKey] = { date: weekKey, bal: daily[d].bal };
    });
    return Object.values(weeks).sort((a, b) => a.date.localeCompare(b.date));
  }

  if (period === 'monthly') {
    const months = {};
    dates.forEach(d => {
      const monthKey = d.slice(0, 7);
      months[monthKey] = { date: monthKey + '-01', bal: daily[d].bal };
    });
    return Object.values(months).sort((a, b) => a.date.localeCompare(b.date));
  }

  return [];
}

function buildCombinedData(period) {
  // Sum balances across all active accounts for each date
  const cutoff = getDateCutoff();
  const dateSums = {};

  for (const login of activeAccounts) {
    const daily = analyticsAccounts[login]?.daily;
    if (!daily) continue;

    let dates = Object.keys(daily).sort();
    if (cutoff) dates = dates.filter(d => d >= cutoff);

    dates.forEach(d => {
      if (!dateSums[d]) dateSums[d] = 0;
      dateSums[d] += daily[d].bal;
    });
  }

  // Only keep dates where ALL active accounts have data (avoid partial sums)
  const allDates = Object.keys(dateSums).sort();
  const fullDates = allDates.filter(d => {
    for (const login of activeAccounts) {
      const daily = analyticsAccounts[login]?.daily;
      if (!daily || !daily[d]) return false;
    }
    return true;
  });

  const combined = {};
  fullDates.forEach(d => { combined[d] = { bal: dateSums[d] }; });

  return aggregateData(combined, period);
}

function renderChart() {
  const canvas = document.getElementById('growthChart');
  const ctx = canvas.getContext('2d');

  if (growthChart) {
    growthChart.destroy();
    growthChart = null;
  }

  if (activeAccounts.size === 0 && !showCombined) {
    canvas.style.display = 'none';
    const wrap = canvas.parentElement;
    let empty = wrap.querySelector('.chart-empty');
    if (!empty) {
      empty = document.createElement('div');
      empty.className = 'chart-empty';
      empty.textContent = 'Select an account to view';
      wrap.appendChild(empty);
    }
    return;
  }

  canvas.style.display = '';
  const existing = canvas.parentElement.querySelector('.chart-empty');
  if (existing) existing.remove();

  // Build unified date labels across all active accounts
  const allDatesSet = new Set();
  const logins = Object.keys(analyticsAccounts);
  const acctPoints = {};

  logins.forEach(login => {
    if (!activeAccounts.has(login)) return;
    const acct = analyticsAccounts[login];
    const points = aggregateData(acct.daily, currentPeriod);
    acctPoints[login] = {};
    points.forEach(p => {
      allDatesSet.add(p.date);
      acctPoints[login][p.date] = p.bal;
    });
  });

  // Add combined dates
  let combinedPoints = {};
  if (showCombined && activeAccounts.size > 0) {
    const cData = buildCombinedData(currentPeriod);
    cData.forEach(p => {
      allDatesSet.add(p.date);
      combinedPoints[p.date] = p.bal;
    });
  }

  const allDates = [...allDatesSet].sort();

  // Build datasets
  const datasets = [];
  logins.forEach((login, i) => {
    if (!activeAccounts.has(login)) return;
    const acct = analyticsAccounts[login];
    datasets.push({
      label: acct.name,
      data: allDates.map(d => acctPoints[login]?.[d] ?? null),
      borderColor: CHART_COLORS[i % CHART_COLORS.length],
      borderWidth: 2,
      pointRadius: currentPeriod === 'monthly' ? 4 : currentPeriod === 'weekly' ? 2.5 : 0,
      pointHoverRadius: 5,
      tension: 0.3,
      fill: false,
      spanGaps: true,
    });
  });

  // Combined line
  if (showCombined && activeAccounts.size > 0) {
    datasets.push({
      label: 'Combined',
      data: allDates.map(d => combinedPoints[d] ?? null),
      borderColor: COMBINED_COLOR,
      borderWidth: 2.5,
      borderDash: [6, 3],
      pointRadius: currentPeriod === 'monthly' ? 4 : currentPeriod === 'weekly' ? 2.5 : 0,
      pointHoverRadius: 5,
      tension: 0.3,
      fill: false,
      spanGaps: true,
    });
  }

  growthChart = new Chart(ctx, {
    type: 'line',
    data: { labels: allDates, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      plugins: {
        legend: {
          display: false,
        },
        tooltip: {
          backgroundColor: '#1e1e2e',
          titleColor: '#aaa',
          bodyColor: '#fff',
          borderColor: 'rgba(255,255,255,0.1)',
          borderWidth: 1,
          titleFont: { family: 'DM Sans', size: 11 },
          bodyFont: { family: 'JetBrains Mono', size: 12 },
          padding: 12,
          callbacks: {
            title: (items) => {
              if (!items.length) return '';
              const dateStr = allDates[items[0].dataIndex];
              const d = new Date(dateStr + 'T00:00:00');
              if (currentPeriod === 'monthly') return d.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
              if (currentPeriod === 'weekly') return 'Week of ' + d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
              return d.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            },
            label: (item) => {
              if (item.parsed.y == null) return null;
              return ' ' + item.dataset.label + ':  $' + item.parsed.y.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            },
          },
        },
      },
      scales: {
        x: {
          grid: { color: 'rgba(255,255,255,0.04)' },
          ticks: {
            color: '#666',
            font: { family: 'DM Sans', size: 10 },
            maxTicksLimit: 12,
            callback: function(value, index) {
              const dateStr = allDates[index];
              if (!dateStr) return '';
              const d = new Date(dateStr + 'T00:00:00');
              if (currentPeriod === 'monthly') return d.toLocaleDateString(undefined, { month: 'short', year: '2-digit' });
              return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
            },
          },
        },
        y: {
          grid: { color: 'rgba(255,255,255,0.04)' },
          ticks: {
            color: '#666',
            font: { family: 'JetBrains Mono', size: 10 },
            callback: (v) => '$' + v.toLocaleString(),
          },
        },
      },
    },
  });
}

// ‚îÄ‚îÄ‚îÄ COLLAPSE STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const collapsedCards = new Set();
const expandedPositions = new Set();

function toggleCard(headerEl) {
  const card = headerEl.closest('.account-card');
  const login = card.dataset.login;
  const body = card.querySelector('.card-body');
  const chevron = card.querySelector('.card-chevron');

  if (collapsedCards.has(login)) {
    collapsedCards.delete(login);
    body.classList.remove('collapsed');
    chevron.classList.remove('collapsed');
    headerEl.style.borderBottom = '';
  } else {
    collapsedCards.add(login);
    body.classList.add('collapsed');
    chevron.classList.add('collapsed');
    headerEl.style.borderBottom = 'none';
  }
}

function togglePositions(headerEl, login) {
  const body = headerEl.nextElementSibling;
  const chevron = headerEl.querySelector('.pos-chevron');

  if (expandedPositions.has(login)) {
    expandedPositions.delete(login);
    body.classList.add('collapsed');
    chevron.classList.add('collapsed');
    headerEl.classList.add('no-border');
  } else {
    expandedPositions.add(login);
    body.classList.remove('collapsed');
    chevron.classList.remove('collapsed');
    headerEl.classList.remove('no-border');
  }
}

// ‚îÄ‚îÄ‚îÄ HISTORY FLYOUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openHistory(login) {
  const flyout = document.getElementById('historyFlyout');
  const title = document.getElementById('flyoutTitle');
  const subtitle = document.getElementById('flyoutSubtitle');
  const summary = document.getElementById('flyoutSummary');
  const body = document.getElementById('flyoutBody');

  // Determine if this is a master account
  const isMaster = login.startsWith('master_');
  const realLogin = isMaster ? login.replace('master_', '') : login;

  // Find account name
  let name;
  if (isMaster) {
    const mAcct = masterData[realLogin];
    name = mAcct ? 'Master: ' + mAcct.name : 'Master #' + realLogin;
  } else {
    const acct = accountsData[realLogin];
    name = acct ? acct.name : 'Account #' + realLogin;
  }

  title.textContent = 'Trade History';
  subtitle.textContent = name + ' #' + realLogin;

  const histRaw = isMaster ? masterHistoryData[realLogin] : historyData[realLogin];

  // Support both old format (array) and new format ({gmtOff, trades})
  let trades, gmtOff = 0;
  if (Array.isArray(histRaw)) {
    trades = histRaw;
  } else if (histRaw && histRaw.trades) {
    trades = histRaw.trades;
    gmtOff = histRaw.gmtOff || 0;  // seconds east of UTC
    // Sanity check: gmtOff must be between -12h and +14h
    if (gmtOff < -43200 || gmtOff > 50400) gmtOff = 7200;
  } else {
    trades = null;
  }

  if (!trades || trades.length === 0) {
    summary.innerHTML = '';
    body.innerHTML = '<div class="flyout-empty">No trade history available yet.<br>History is sent when the v1.3+ EA is running.</div>';
    flyout.classList.add('show');
    return;
  }

  // Show most recent trades first
  const reversed = [...trades].reverse();

  // Summary stats
  const totalPnl = reversed.reduce((s, t) => s + t.pnl, 0);
  const wins = reversed.filter(t => t.pnl > 0).length;
  const losses = reversed.filter(t => t.pnl < 0).length;
  const winRate = reversed.length > 0 ? (wins / reversed.length * 100) : 0;
  const pnlClass = totalPnl >= 0 ? 'pnl-pos' : 'pnl-neg';

  summary.innerHTML = `
    <div>
      <div class="flyout-stat-label">Trades</div>
      <div class="flyout-stat-value">${reversed.length}</div>
    </div>
    <div>
      <div class="flyout-stat-label">Net P&L</div>
      <div class="flyout-stat-value ${pnlClass}">${totalPnl >= 0 ? '+' : '-'}$${Math.abs(totalPnl).toFixed(2)}</div>
    </div>
    <div>
      <div class="flyout-stat-label">Win Rate</div>
      <div class="flyout-stat-value">${winRate.toFixed(0)}%</div>
    </div>
    <div>
      <div class="flyout-stat-label">W / L</div>
      <div class="flyout-stat-value"><span class="pnl-pos">${wins}</span> / <span class="pnl-neg">${losses}</span></div>
    </div>
  `;

  // Convert server time to user's local time using gmtOff from EA
  function fmtTime(t) {
    if (!t) return '‚Äî';
    // t = "2026.02.17 18:31:42" (server time, offset by gmtOff seconds from UTC)
    const iso = t.replace(/\./g, '-').replace(' ', 'T') + 'Z';
    const utcMs = new Date(iso).getTime() - (gmtOff * 1000);
    const local = new Date(utcMs);
    return local.toLocaleDateString(undefined, { month: '2-digit', day: '2-digit' }) + ' ' +
           local.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
  }

  // Extract bot name from label (same logic as master card)
  function getBotFromTrade(t) {
    const src = t.label || t.comment || '';
    const match = src.match(/_([^_:]+):[^:]+$/);
    return match ? match[1] : null;
  }

  let tableHTML = `
    <table class="flyout-table">
      <thead><tr>
        <th>Closed</th>
        ${isMaster ? '<th>Bot</th>' : ''}
        <th>Dir</th>
        <th>Vol</th>
        <th>Open</th>
        <th>Close</th>
        <th>P&L</th>
      </tr></thead>
      <tbody>`;

  reversed.forEach(t => {
    const dirClass = t.dir === 'BUY' ? 'dir-buy' : 'dir-sell';
    const pnlCls = t.pnl >= 0 ? 'pnl-pos' : 'pnl-neg';
    const dig = t.op > 100 ? 2 : 5;
    const bot = isMaster ? (getBotFromTrade(t) || 'Manual') : '';
    tableHTML += `
      <tr>
        <td>${fmtTime(t.ct)}</td>
        ${isMaster ? '<td class="master-label-cell">' + bot + '</td>' : ''}
        <td class="${dirClass}">${t.dir}</td>
        <td>${t.vol.toFixed(2)}</td>
        <td>${t.op.toFixed(dig)}</td>
        <td>${t.cp.toFixed(dig)}</td>
        <td class="${pnlCls}">${t.pnl >= 0 ? '+' : '-'}$${Math.abs(t.pnl).toFixed(2)}</td>
      </tr>`;
  });

  tableHTML += '</tbody></table>';
  body.innerHTML = tableHTML;

  flyout.classList.add('show');
}

function closeFlyout() {
  document.getElementById('historyFlyout').classList.remove('show');
}

// Close flyout on overlay click (not panel click)
document.getElementById('historyFlyout').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeFlyout();
});

// Close flyout on Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeFlyout();
});

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// --- Load daily history from /history/{login}/daily ---
function loadDailyHistory(logins) {
  logins.forEach(login => {
    db.ref('history/' + login + '/daily').on('value', (snap) => {
      const val = snap.val();
      if (val) {
        dailyHistory[login] = val;
        // Re-render to update 7D/30D stats
        if (Object.keys(accountsData).length > 0) {
          renderAccounts(accountsData);
        }
      }
    });
  });
}

// --- Calculate P&L for a period from daily history ---
// period = number of prior days (e.g. 7 = yesterday back 7 days)
// Uses user's local timezone for "yesterday"
function calcPeriodPnl(period, filterLogins) {
  let totalPnl = 0;
  let hasData = false;

  // Build date range in user's local timezone: yesterday back N days
  const today = new Date();
  const dates = [];
  for (let i = 1; i <= period; i++) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    // Format as YYYY-MM-DD to match daily ledger keys
    dates.push(d.toLocaleDateString('en-CA'));
  }

  for (const [login, daily] of Object.entries(dailyHistory)) {
    if (filterLogins && !filterLogins.includes(login)) continue;
    if (!daily) continue;
    for (const dateKey of dates) {
      if (daily[dateKey]) {
        totalPnl += daily[dateKey].pnl || 0;
        hasData = true;
      }
    }
  }

  return hasData ? totalPnl : null;  // null = no data yet
}

// --- Calculate starting balance for a period (for % calc) ---
function calcPeriodStartBal(period, filterLogins) {
  // Find the balance at end of the day BEFORE the period started
  // Search backwards up to 5 extra days in case of weekends/gaps
  let totalBal = 0;
  let found = false;

  for (let offset = period + 1; offset <= period + 5; offset++) {
    const d = new Date();
    d.setDate(d.getDate() - offset);
    const dateKey = d.toLocaleDateString('en-CA');

    totalBal = 0;
    found = false;

    for (const [login, daily] of Object.entries(dailyHistory)) {
      if (filterLogins && !filterLogins.includes(login)) continue;
      if (!daily) continue;
      if (daily[dateKey]) {
        totalBal += daily[dateKey].bal || 0;
        found = true;
      }
    }

    if (found) break;
  }

  return found ? totalBal : null;
}

// --- Calculate today's realized P&L from EA trade history ---
// "Today" = since midnight in the user's local timezone
function calcTodayPnl(filterLogins) {
  let total = 0;

  // User's local "today" as YYYY-MM-DD
  const localToday = new Date().toLocaleDateString('en-CA'); // en-CA gives YYYY-MM-DD

  for (const [login, histRaw] of Object.entries(historyData)) {
    if (filterLogins && !filterLogins.includes(login)) continue;
    let trades, gmtOff = 7200; // Default GMT+2 (Coinexx)
    if (Array.isArray(histRaw)) {
      trades = histRaw;
    } else if (histRaw && histRaw.trades) {
      trades = histRaw.trades;
      gmtOff = histRaw.gmtOff || 7200;
    } else {
      continue;
    }

    // Sanity check: gmtOff must be between -12h and +14h (-43200 to 50400 seconds)
    // During market close, MT5's TimeCurrent() freezes and produces wildly wrong offsets
    if (gmtOff < -43200 || gmtOff > 50400) gmtOff = 7200;

    for (const t of trades) {
      if (!t.ct) continue;
      // ct = "2026.02.18 18:31:07" (broker server time)
      // Convert to UTC: parse as if UTC, then subtract gmtOff
      const iso = t.ct.replace(/\./g, '-').replace(' ', 'T') + 'Z';
      const utcMs = new Date(iso).getTime() - (gmtOff * 1000);
      // Check if this UTC timestamp falls on "today" in user's local timezone
      const tradeLocalDate = new Date(utcMs).toLocaleDateString('en-CA');
      if (tradeLocalDate === localToday) {
        total += (t.pnl || 0) + (t.sw || 0) + (t.cm || 0);
      }
    }
  }

  return total;
}

function buildSummaryHTML(title, accts, filterLogins) {
  let totalBal = 0;
  accts.forEach(a => { totalBal += a.bal || 0; });

  const todayPnl = calcTodayPnl(filterLogins);
  const startOfDayBal = totalBal - todayPnl;
  const todayPct = startOfDayBal > 0 ? (todayPnl / startOfDayBal * 100) : 0;
  const pnlClass = todayPnl >= 0 ? 'positive' : 'negative';

  const pnl7d = calcPeriodPnl(7, filterLogins);
  const pnl30d = calcPeriodPnl(30, filterLogins);
  const startBal7d = calcPeriodStartBal(7, filterLogins);
  const startBal30d = calcPeriodStartBal(30, filterLogins);
  const pct7d = (pnl7d !== null && startBal7d) ? (pnl7d / startBal7d * 100) : null;
  const pct30d = (pnl30d !== null && startBal30d) ? (pnl30d / startBal30d * 100) : null;
  const pnl7dClass = pnl7d !== null ? (pnl7d >= 0 ? 'positive' : 'negative') : '';
  const pnl30dClass = pnl30d !== null ? (pnl30d >= 0 ? 'positive' : 'negative') : '';

  const fmt7d = pnl7d !== null
    ? `<div class="summary-pnl-row">
         <div class="summary-item-value ${pnl7dClass}">${pnl7d >= 0 ? '+' : '-'}$${formatNum(Math.abs(pnl7d))}</div>
         <div class="summary-pnl-pct ${pnl7dClass}">${pct7d !== null ? (pct7d >= 0 ? '+' : '') + pct7d.toFixed(2) + '%' : '‚Äî'}</div>
       </div>`
    : `<div class="summary-item-value" style="color:var(--text-dim)">‚Äî</div>`;

  const fmt30d = pnl30d !== null
    ? `<div class="summary-pnl-row">
         <div class="summary-item-value ${pnl30dClass}">${pnl30d >= 0 ? '+' : '-'}$${formatNum(Math.abs(pnl30d))}</div>
         <div class="summary-pnl-pct ${pnl30dClass}">${pct30d !== null ? (pct30d >= 0 ? '+' : '') + pct30d.toFixed(2) + '%' : '‚Äî'}</div>
       </div>`
    : `<div class="summary-item-value" style="color:var(--text-dim)">‚Äî</div>`;

  return `
    <div class="summary-card">
      <div class="summary-card-header">${title}</div>
      <div class="summary-card-body">
        <div class="summary-item">
          <div class="summary-item-label">Current Balance</div>
          <div class="summary-item-value"><span class="currency">$</span>${formatNum(totalBal)}</div>
        </div>
        <div class="summary-item">
          <div class="summary-item-label">Today's P&L</div>
          <div class="summary-pnl-row">
            <div class="summary-item-value ${pnlClass}">${todayPnl >= 0 ? '+' : '-'}$${formatNum(Math.abs(todayPnl))}</div>
            <div class="summary-pnl-pct ${pnlClass}">${todayPct >= 0 ? '+' : ''}${todayPct.toFixed(2)}%</div>
          </div>
        </div>
        <div class="summary-item">
          <div class="summary-item-label">Last 7 Days' P&L</div>
          ${fmt7d}
        </div>
        <div class="summary-item">
          <div class="summary-item-label">Last 30 Days' P&L</div>
          ${fmt30d}
        </div>
      </div>
    </div>`;
}

function renderAccounts(data) {
  const accounts = Object.values(data);
  let html = '';

  // Master account cards (admin always, or future: viewers with access flag)
  const showMaster = isAdmin || canViewMaster;
  const masters = Object.values(masterData);
  console.log('[Master] renderAccounts: showMaster=', showMaster, 'masters.length=', masters.length);
  if (showMaster && masters.length > 0) {
    html += '<div class="accounts-grid">';
    masters.forEach(m => { html += renderMasterCard(m); });
    html += '</div>';
  }

  if (isAdmin) {
    // Group accounts by viewer
    const groups = {};
    accounts.forEach(acct => {
      const vKey = acct._viewerKey || 'unknown';
      const vName = acct._viewerName || vKey;
      if (!groups[vKey]) groups[vKey] = { name: vName, logins: [], accounts: [] };
      groups[vKey].accounts.push(acct);
      if (acct.login) groups[vKey].logins.push(String(acct.login));
    });

    // Per-viewer summary + cards
    for (const group of Object.values(groups)) {
      html += '<div class="viewer-section">';
      html += buildSummaryHTML(group.name, group.accounts, group.logins);
      html += '<div class="accounts-grid">';
      group.accounts.forEach(acct => { html += renderCard(acct); });
      html += '</div>';
      html += '</div>';
    }
  } else {
    html += buildSummaryHTML('Accounts Summary', accounts, null);
    // Info button (only for normal mode ‚Äî admin has multiple summaries)
    html = html.replace(
      '<div class="summary-card-header">Accounts Summary</div>',
      `<div class="summary-card-header">
        Accounts Summary
        <div class="summary-info-icon" id="summaryInfoToggle">i</div>
        <div class="summary-info-popup" id="summaryInfoPopup">
          <p><strong style="color:var(--text)">Today's P&L</strong> includes all trades closed since midnight in your local timezone.</p>
          <p><strong style="color:var(--text)">Last 7 &amp; 30 Days</strong> cover the prior 7 or 30 days starting from yesterday ‚Äî they don't include today. Updated every 12 hours.</p>
        </div>
      </div>`
    );
    html += '<div class="accounts-grid">';
    accounts.forEach(acct => { html += renderCard(acct); });
    html += '</div>';
  }

  app.innerHTML = html;

  // Restore collapse state
  collapsedCards.forEach(login => {
    const card = app.querySelector(`.account-card[data-login="${login}"]`);
    if (card) {
      card.querySelector('.card-body').classList.add('collapsed');
      card.querySelector('.card-chevron').classList.add('collapsed');
      card.querySelector('.card-header').style.borderBottom = 'none';
    }
  });

  // Restore expanded positions state
  expandedPositions.forEach(login => {
    const card = app.querySelector(`.account-card[data-login="${login}"]`);
    if (card) {
      const posHeader = card.querySelector('.positions-header');
      const posBody = card.querySelector('.positions-body');
      const posChevron = card.querySelector('.pos-chevron');
      if (posHeader && posBody && posChevron) {
        posBody.classList.remove('collapsed');
        posChevron.classList.remove('collapsed');
        posHeader.classList.remove('no-border');
      }
    }
  });

  // Summary info popup
  const sInfoBtn = document.getElementById('summaryInfoToggle');
  const sInfoPop = document.getElementById('summaryInfoPopup');
  if (sInfoBtn && sInfoPop) {
    sInfoBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      sInfoPop.classList.toggle('show');
    });
  }
}

function renderMasterCard(m) {
  const freshness = getFreshness(m.time, m.status, m.updatedAt);
  const statusClass = freshness === 'live' ? '' : freshness;
  const statusLabel = getStatusLabel(freshness, m.status);

  const floatPnl = m.floatingPnl || 0;
  const floatClass = floatPnl >= 0 ? 'positive' : 'negative';
  const floatPct = m.bal !== 0 ? (floatPnl / m.bal * 100) : 0;

  const posArr = m.positions ? (Array.isArray(m.positions) ? m.positions : Object.values(m.positions)) : [];
  const posCount = posArr.length;

  // Extract bot name from label like "GRID_XAUUSD_Chanel:Abxt8v0d2"
  function getBotName(p) {
    const src = p.label || p.comment || '';
    const match = src.match(/_([^_:]+):[^:]+$/);
    return match ? match[1] : null;
  }

  // Group positions by bot
  const groups = {};
  posArr.forEach(p => {
    const bot = getBotName(p) || '_manual';
    if (!groups[bot]) groups[bot] = [];
    groups[bot].push(p);
  });

  let posContentHTML = '';
  if (posCount > 0) {
    // Sort: named bots first (alphabetical), manual last
    const botNames = Object.keys(groups).sort((a, b) => {
      if (a === '_manual') return 1;
      if (b === '_manual') return -1;
      return a.localeCompare(b);
    });

    botNames.forEach(bot => {
      const positions = groups[bot];
      const groupPnl = positions.reduce((s, p) => s + (p.pnl || 0), 0);
      const groupVol = positions.reduce((s, p) => s + (p.vol || 0), 0);
      const pnlClass = groupPnl >= 0 ? 'pnl-pos' : 'pnl-neg';
      const label = bot === '_manual' ? 'Manual' : bot;

      posContentHTML += `
        <div class="master-bot-group">
          <div class="master-bot-header">
            <span class="master-bot-name">${label}</span>
            <span class="master-bot-stats">
              ${positions.length} pos ¬∑ ${groupVol.toFixed(2)} lots ¬∑ <span class="${pnlClass}">${formatMoney(groupPnl)}</span>
            </span>
          </div>
          <table class="positions-table">
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Dir</th>
                <th>Vol</th>
                <th>Entry</th>
                <th>P&L</th>
                <th>Bot</th>
              </tr>
            </thead>
            <tbody>
              ${positions.map(p => `
                <tr>
                  <td>${p.sym || ''}</td>
                  <td class="${p.dir === 'BUY' ? 'dir-buy' : 'dir-sell'}">${p.dir || ''}</td>
                  <td>${(p.vol || 0).toFixed(2)}</td>
                  <td>${formatPrice(p.ep || 0)}</td>
                  <td class="${(p.pnl || 0) >= 0 ? 'pnl-pos' : 'pnl-neg'}">${formatMoney(p.pnl || 0)}</td>
                  <td class="master-label-cell">${bot === '_manual' ? '‚Äî' : label}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>`;
    });
  } else {
    posContentHTML = '<div class="no-positions">No open positions</div>';
  }

  const positionsHTML = `
      <div class="positions-section">
        <div class="positions-header no-border" onclick="togglePositions(this, 'master_${m.login}')">
          <span>Open Positions: ${posCount}</span>
          <svg class="pos-chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="4,2 12,8 4,14"/></svg>
        </div>
        <div class="positions-body">
          <div class="positions-body-inner">
            ${posContentHTML}
          </div>
        </div>
      </div>`;

  return `
    <div class="account-card master-card" data-login="master_${m.login}">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left">
          <svg class="card-chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="4,2 12,8 4,14"/></svg>
          <div>
            <div class="card-name">Master: ${m.name}</div>
            <div class="card-meta">${m.broker} ¬∑ ${m.ccy}</div>
          </div>
        </div>
        <div class="card-header-right">
          <div class="history-btn" onclick="event.stopPropagation(); openHistory('master_${m.login}')" title="Trade History">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          </div>
          <div class="card-status ${statusClass}">
            <div class="card-status-dot"></div>
            ${statusLabel}
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="card-body-inner">
          <div class="metrics">
            <div class="metric">
              <div class="metric-label">Balance</div>
              <div class="metric-value"><span class="currency">$</span>${formatNum(m.bal)}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Equity</div>
              <div class="metric-value"><span class="currency">$</span>${formatNum(m.eq)}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Floating P&L</div>
              <div class="metric-value ${floatClass}">${formatMoney(floatPnl)}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Float %</div>
              <div class="metric-value ${floatClass}">${floatPct >= 0 ? '+' : ''}${floatPct.toFixed(2)}<span class="pct">%</span></div>
            </div>
          </div>
          ${positionsHTML}
        </div>
      </div>
    </div>`;
}

function renderCard(a) {
  const freshness = getFreshness(a.time, a.status, a.updatedAt);
  const statusClass = freshness === 'live' ? '' : freshness;
  const statusLabel = getStatusLabel(freshness, a.status);

  const floatClass = a.pnl >= 0 ? 'positive' : 'negative';
  const floatPct = a.bal !== 0 ? (a.pnl / a.bal * 100) : 0;

  let positionsHTML = '';
  const posCount = a.positions ? a.positions.length : 0;
  const posTableHTML = posCount > 0 ? `
            <table class="positions-table">
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Dir</th>
                  <th>Volume</th>
                  <th>Open</th>
                  <th>Current</th>
                  <th>P&L</th>
                </tr>
              </thead>
              <tbody>
                ${a.positions.map(p => `
                  <tr>
                    <td>${p.sy}</td>
                    <td class="${p.dir === 'BUY' ? 'dir-buy' : 'dir-sell'}">${p.dir}</td>
                    <td>${p.vol.toFixed(2)}</td>
                    <td>${formatPrice(p.op)}</td>
                    <td>${formatPrice(p.cp)}</td>
                    <td class="${p.pnl >= 0 ? 'pnl-pos' : 'pnl-neg'}">${formatMoney(p.pnl)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>` : `<div class="no-positions">No open positions</div>`;

  positionsHTML = `
      <div class="positions-section">
        <div class="positions-header no-border" onclick="togglePositions(this, '${a.login}')">
          <span>Open Positions: ${posCount}</span>
          <svg class="pos-chevron collapsed" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="4,2 12,8 4,14"/></svg>
        </div>
        <div class="positions-body collapsed">
          <div class="positions-body-inner">
            ${posTableHTML}
          </div>
        </div>
      </div>`;

  return `
    <div class="account-card" data-login="${a.login}">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-header-left">
          <svg class="card-chevron" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="4,2 12,8 4,14"/></svg>
          <div>
            <div class="card-name">${a.name} <span class="card-meta" style="font-size:13px;margin-left:4px">#${a.login}</span></div>
            <div class="card-meta">${a.broker} ¬∑ ${a.ccy}</div>
          </div>
        </div>
        <div class="card-header-right">
          <div class="history-btn" onclick="event.stopPropagation(); openHistory('${a.login}')" title="Trade History">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          </div>
          <div class="card-status ${statusClass}">
            <div class="card-status-dot"></div>
            ${statusLabel}
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="card-body-inner">
          <div class="metrics">
            <div class="metric">
              <div class="metric-label">Balance</div>
              <div class="metric-value"><span class="currency">$</span>${formatNum(a.bal)}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Equity</div>
              <div class="metric-value"><span class="currency">$</span>${formatNum(a.eq)}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Floating P&L</div>
              <div class="metric-value ${floatClass}">${formatMoney(a.pnl)}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Float %</div>
              <div class="metric-value ${floatClass}">${floatPct >= 0 ? '+' : ''}${floatPct.toFixed(2)}<span class="pct">%</span></div>
            </div>
          </div>
          ${positionsHTML}
        </div>
      </div>
    </div>`;
}

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function formatNum(n) {
  return n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatMoney(n) {
  const sign = n >= 0 ? '+' : '';
  return `<span class="currency">$</span>${sign}${formatNum(n)}`;
}

function formatPrice(n) {
  if (n >= 100) return n.toFixed(2);
  if (n >= 1) return n.toFixed(4);
  return n.toFixed(5);
}

function getFreshness(timeStr, status, updatedAt) {
  // Use updatedAt (system clock / UTC) if available, fall back to time (broker time)
  const checkTime = updatedAt || timeStr;
  if (!checkTime) return 'offline';

  // Parse time format: "2026.02.17 15:28:47" or "2026-02-17 15:28:47"
  const parts = checkTime.replace(/\./g, '-').replace(' ', 'T') + 'Z';
  const then = new Date(parts).getTime();
  const now = Date.now();
  const diffSec = (now - then) / 1000;

  if (diffSec < 0) return status === 'closed' || status === 'hold' ? 'closed' : 'live';

  // Thresholds adjust based on EA status:
  //   Market open (active/idle): stale at 2min, offline at 10min
  //   Market closed (closed/hold): stale at 7min, offline at 15min
  const isMarketClosed = (status === 'closed' || status === 'hold');

  if (isMarketClosed) {
    if (diffSec < 420) return 'closed';   // Under 7 min = market closed (healthy)
    if (diffSec < 900) return 'stale';    // 7-15 min = stale
    return 'offline';                      // Over 15 min = offline
  } else {
    if (diffSec < 120) return 'live';     // Under 2 min = live
    if (diffSec < 600) return 'stale';    // 2-10 min = stale
    return 'offline';                      // Over 10 min = offline
  }
}

function getStatusLabel(freshness, status) {
  if (freshness === 'offline') return 'OFFLINE';
  if (freshness === 'stale') return 'STALE';
  if (freshness === 'closed') {
    return status === 'hold' ? 'HOLDING' : 'MKT CLOSED';
  }
  return 'LIVE';
}

function updateGlobalStatus(data) {
  const accounts = Object.values(data);
  const freshStates = accounts.map(a => getFreshness(a.time, a.status, a.updatedAt));

  let globalState = 'live';
  if (freshStates.includes('offline')) globalState = 'offline';
  else if (freshStates.includes('stale')) globalState = 'stale';
  else if (freshStates.every(s => s === 'closed')) globalState = 'closed';

  globalStatus.className = 'header-logo' + (globalState !== 'live' ? ' ' + globalState : '');

  const times = accounts.map(a => a.time).filter(Boolean);
  if (times.length > 0) {
    const latest = times.sort().reverse()[0];
    lastUpdateEl.textContent = 'Last update: ' + latest;
  }
}

// ‚îÄ‚îÄ‚îÄ SERVICE WORKER (cache busting for iOS home screen) ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

// ‚îÄ‚îÄ‚îÄ FRESHNESS RE-EVALUATION (every 30s) ‚îÄ‚îÄ
// Re-renders status badges without waiting for Firebase push
setInterval(() => {
  if (Object.keys(accountsData).length > 0) {
    renderAccounts(accountsData);
    updateGlobalStatus(accountsData);
  }
}, 30000);
</script>

</body>
</html>
